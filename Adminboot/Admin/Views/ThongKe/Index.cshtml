@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Thống kê sản phẩm";
}

<link rel="shortcut icon" type="image/x-icon" href="~/Admin/img/favicon.jpg">
<link rel="stylesheet" href="~/Admin/css/bootstrap.min.css">
<link rel="stylesheet" href="~/Admin/css/animate.css">
<link rel="stylesheet" href="~/Admin/plugins/select2/css/select2.min.css">
<link rel="stylesheet" href="~/Admin/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="~/Admin/plugins/fontawesome/css/fontawesome.min.css">
<link rel="stylesheet" href="~/Admin/plugins/fontawesome/css/all.min.css">
<link rel="stylesheet" href="~/Admin/css/style.css">

<script src="~/Admin/js/jquery-3.6.0.min.js"></script>
<script src="~/Admin/js/feather.min.js"></script>
<script src="~/Admin/js/jquery.slimscroll.min.js"></script>
<script src="~/Admin/js/jquery.dataTables.min.js"></script>
<script src="~/Admin/js/dataTables.bootstrap4.min.js"></script>
<script src="~/Admin/js/bootstrap.bundle.min.js"></script>
<script src="~/Admin/plugins/select2/js/select2.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalerts.min.js"></script>
<script src="~/Admin/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-wrapper">
    <div class="content container-fluid">
        <!-- Bộ lọc -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label>Từ ngày</label>
                <input type="date" id="tuNgay" class="form-control" />
            </div>
            <div class="col-md-3">
                <label>Đến ngày</label>
                <input type="date" id="denNgay" class="form-control" />
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-success mr-2" id="btnApDung">Áp dụng</button>
                <button class="btn btn-danger mr-2" id="btnTuanHienTai">Tuần hiện tại</button>
                <button class="btn btn-primary" id="btnXuatExcel">Xuất Excel</button>
            </div>
        </div>

        <!-- Widget thống kê nhanh -->
        <div class="row mb-4">
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget">
                    <div class="dash-widgetimg">
                        <span><img src="~/Admin/img/icons/dash1.svg" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5><span id="tongDoanhThu">0</span> VND</h5>
                        <h6>Tổng doanh thu</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget dash1">
                    <div class="dash-widgetimg">
                        <span><img src="~/Admin/img/icons/dash2.svg" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5><span id="tongDonHang">0</span></h5>
                        <h6>Tổng đơn hàng</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget dash2">
                    <div class="dash-widgetimg">
                        <span><img src="~/Admin/img/icons/dash3.svg" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5><span id="tongSanPhamBan">0</span></h5>
                        <h6>Tổng sản phẩm bán</h6>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6 col-12">
                <div class="dash-widget dash3">
                    <div class="dash-widgetimg">
                        <span><img src="~/Admin/img/icons/dash4.svg" alt="img"></span>
                    </div>
                    <div class="dash-widgetcontent">
                        <h5><span id="tongKhachHang">0</span></h5>
                        <h6>Tổng khách hàng</h6>
                    </div>
                </div>
            </div>
        </div>

  

        <!-- Biểu đồ -->
        <div class="row">
            <div class="col-md-6">
                <h5>Top 10 sản phẩm bán chạy</h5>
                <canvas id="chartTopSanPham" height="200"></canvas>
            </div>
            <div class="col-md-6">
                <h5>Biểu đồ thống kê doanh thu</h5>
                <canvas id="chartDoanhThu" height="200"></canvas>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <h5>Danh sách chi tiết sản phẩm đã bán</h5>
                <table id="tableChiTiet" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Ngày đặt</th>
                            <th>Tên sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Đơn giá (VND)</th>
                            <th>Thành tiền (VND)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script>
        function loadThongKeTongQuat(tuNgay, denNgay) {
        $.getJSON(`/Admin/ThongKe/ThongKeTongQuat?tuNgay=${tuNgay}&denNgay=${denNgay}`, function (data) {
            $("#tongDoanhThu").text(data.tongDoanhThu.toLocaleString('vi-VN'));
            $("#tongDonHang").text(data.tongDonHang);
            $("#tongSanPhamBan").text(data.tongSanPham);
            $("#tongKhachHang").text(data.tongKhachHang);
        });
    }

    let chartDoanhThu, chartTopSanPham;

    function loadDoanhThu(tuNgay, denNgay) {
        $.getJSON(`/Admin/ThongKe/DoanhThu?tuNgay=${tuNgay}&denNgay=${denNgay}`, function (data) {
            const labels = data.map(x => new Date(x.ngay).toLocaleDateString('vi-VN'));
            const values = data.map(x => x.tongDoanhThu);

            if (chartDoanhThu) chartDoanhThu.destroy();
            chartDoanhThu = new Chart(document.getElementById('chartDoanhThu'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VND)',
                        data: values,
                        backgroundColor: '#007bff'
                    }]
                }
            });
        });
    }

    function loadTopSanPham() {
        $.getJSON(`/Admin/ThongKe/TopSanPham`, function (data) {
            const labels = data.map(x => x.tenSP);
            const values = data.map(x => x.tongSoLuong);

            if (chartTopSanPham) chartTopSanPham.destroy();
            chartTopSanPham = new Chart(document.getElementById('chartTopSanPham'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng bán',
                        data: values,
                        backgroundColor: '#28a745'
                    }]
                }
            });
        });
    }

    function loadChiTietSanPham(tuNgay, denNgay) {
        $.getJSON(`/Admin/ThongKe/ChiTietSanPham?tuNgay=${tuNgay}&denNgay=${denNgay}`, function (data) {
            let tbody = $("#tableChiTiet tbody");
            tbody.empty();

            data.forEach(item => {
                tbody.append(`
                    <tr>
                        <td>${new Date(item.ngayDat).toLocaleDateString('vi-VN')}</td>
                        <td>${item.tenSP}</td>
                        <td>${item.soLuong}</td>
                        <td>${item.donGia.toLocaleString('vi-VN')}</td>
                        <td>${item.thanhTien.toLocaleString('vi-VN')}</td>
                    </tr>
                `);
            });
        });
    }

    $(document).ready(function () {
        loadThongKeTongQuat($('#tuNgay').val(), $('#denNgay').val());

        // Xác định tuần hiện tại
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Thứ 2
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6); // Chủ nhật

        // Set giá trị input date
        $('#tuNgay').val(startOfWeek.toISOString().split('T')[0]);
        $('#denNgay').val(endOfWeek.toISOString().split('T')[0]);

        // Load mặc định
        loadDoanhThu($('#tuNgay').val(), $('#denNgay').val());
        loadTopSanPham();
        loadChiTietSanPham($('#tuNgay').val(), $('#denNgay').val());

        // Áp dụng filter
        $('#btnApDung').click(function () {
            const tuNgay = $('#tuNgay').val();
            const denNgay = $('#denNgay').val();
            loadDoanhThu(tuNgay, denNgay);
            loadChiTietSanPham(tuNgay, denNgay);
        });

        // Tuần hiện tại
        $('#btnTuanHienTai').click(function () {
            $('#tuNgay').val(startOfWeek.toISOString().split('T')[0]);
            $('#denNgay').val(endOfWeek.toISOString().split('T')[0]);
            loadDoanhThu($('#tuNgay').val(), $('#denNgay').val());
            loadChiTietSanPham($('#tuNgay').val(), $('#denNgay').val());
        });

        // Xuất Excel
        $('#btnXuatExcel').click(function () {
            window.location.href = `/Admin/ThongKe/ExportExcel?tuNgay=${$('#tuNgay').val()}&denNgay=${$('#denNgay').val()}`;
        });
    });
</script>
