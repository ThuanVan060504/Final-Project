@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Báo cáo  sản phẩm";
}
<link rel="shortcut icon" type="image/x-icon" href="~/Admin/img/favicon.jpg">
<link rel="stylesheet" href="~/Admin/css/bootstrap.min.css">
<link rel="stylesheet" href="~/Admin/css/animate.css">
<link rel="stylesheet" href="~/Admin/plugins/select2/css/select2.min.css">
<link rel="stylesheet" href="~/Admin/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="~/Admin/plugins/fontawesome/css/fontawesome.min.css">
<link rel="stylesheet" href="~/Admin/plugins/fontawesome/css/all.min.css">
<link rel="stylesheet" href="~/Admin/css/style.css">

<style>
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 60px;
        flex-wrap: wrap;
        margin-bottom: 50px;
    }

    .chart-box {
        flex: 1 1 45%;
        max-width: 600px;
        background-color: #f9fafd;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 25px 20px 30px 20px;
        text-align: center;
        transition: box-shadow 0.3s ease;
    }

        .chart-box:hover {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }

    h2.mb-4 {
        text-align: center;
        color: #007bff;
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        margin-bottom: 40px;
    }

    .chart-box h4 {
        font-weight: 600;
        margin-bottom: 25px;
        color: #17a2b8;
        font-size: 1.5rem;
    }

    canvas {
        max-width: 100%;
        height: 400px !important;
        margin: 0 auto 25px auto;
        background-color: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
    }

    /* Bảng liệt kê sản phẩm bán chạy */
    #soldProductTable {
        width: 100%;
        border-collapse: collapse;
        font-size: 1.15rem;
        font-weight: 600;
        margin-top: 10px;
    }

        #soldProductTable th, #soldProductTable td {
            border: 1px solid #ddd;
            padding: 12px 16px;
            text-align: left;
            vertical-align: middle;
        }

        #soldProductTable th {
            background-color: #17a2b8;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
        }

        #soldProductTable tbody tr:hover {
            background-color: #f1f9fc;
        }

    /* Bảng liệt kê sản phẩm yêu thích */
    #favoriteTable {
        margin-top: 25px;
        width: 100%;
        border-collapse: collapse;
        font-size: 1.15rem;
        font-weight: 600;
    }

        #favoriteTable th, #favoriteTable td {
            border: 1px solid #ddd;
            padding: 12px 16px;
            text-align: left;
            vertical-align: middle;
        }

        #favoriteTable th {
            background-color: #17a2b8;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
        }

        #favoriteTable tbody tr:hover {
            background-color: #f1f9fc;
        }

    /* Màu sắc chấm tròn đại diện màu biểu đồ */
    .color-dot {
        display: inline-block;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        margin-right: 10px;
        vertical-align: middle;
        border: 1.5px solid #ccc;
    }
</style>

<h2 class="mb-4">📊 Thống kê sản phẩm</h2>

<div class="chart-container">
    <div class="chart-box">
        <h4>Top sản phẩm bán chạy nhất</h4>
        <canvas id="chartBan"></canvas>

        <table id="soldProductTable" aria-label="Danh sách sản phẩm bán chạy">
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    <th>Tên sản phẩm</th>
                    <th style="width: 120px;">Số lượng đã bán</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dữ liệu sẽ đổ qua JS -->
            </tbody>
        </table>
    </div>

    <div class="chart-box">
        <h4>Top sản phẩm yêu thích</h4>
        <canvas id="chartYeuThich"></canvas>

        <table id="favoriteTable" aria-label="Danh sách sản phẩm yêu thích">
            <thead>
                <tr>
                    <th>Màu</th>
                    <th>Tên sản phẩm</th>
                    <th>Số lượt yêu thích</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dữ liệu sẽ đổ qua JS -->
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
    const colors = [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)',
        'rgba(199, 199, 199, 0.6)',
        'rgba(83, 102, 255, 0.6)',
        'rgba(255, 203, 207, 0.6)',
        'rgba(163, 255, 157, 0.6)'
    ];

    // Biểu đồ sản phẩm bán chạy nhất
    fetch('@Url.Action("SanPhamDaBan", "ThongKe", new { area = "Admin" })')
        .then(res => res.json())
        .then(data => {
            const barColors = data.map((_, idx) => colors[idx % colors.length]);

            new Chart(document.getElementById('chartBan'), {
                type: 'bar',
                data: {
                    labels: data.map(x => x.label),
                    datasets: [{
                        label: 'Số lượng đã bán',
                        data: data.map(x => x.value),
                        backgroundColor: barColors,
                        borderRadius: 6,
                        borderSkipped: false,
                        borderWidth: 1,
                        borderColor: '#ccc'
                    }]
                },
                options: {
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 14 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { font: { size: 14 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `Số lượng: ${ctx.parsed.y}`
                            }
                        }
                    }
                }
            });

            const tbody = document.querySelector('#soldProductTable tbody');
            tbody.innerHTML = '';

            data.forEach((item, idx) => {
                const tr = document.createElement('tr');
                if (idx % 2 === 1) tr.style.backgroundColor = '#f9f9f9';

                const tdIndex = document.createElement('td');
                tdIndex.textContent = idx + 1;
                tdIndex.style.textAlign = 'center';
                tdIndex.style.fontWeight = '600';

                const tdName = document.createElement('td');
                tdName.textContent = item.label;
                tdName.style.fontWeight = '600';

                const tdCount = document.createElement('td');
                tdCount.textContent = item.value;
                tdCount.style.fontWeight = '600';
                tdCount.style.textAlign = 'center';

                tr.appendChild(tdIndex);
                tr.appendChild(tdName);
                tr.appendChild(tdCount);

                tbody.appendChild(tr);
            });

            $('#soldProductTable').DataTable({
                paging: true,
                searching: true,
                info: false,
                lengthChange: false,
                pageLength: 5,
                language: {
                    search: "Tìm kiếm:",
                    paginate: {
                        previous: "Trước",
                        next: "Tiếp"
                    },
                    zeroRecords: "Không tìm thấy kết quả"
                }
            });
        })
        .catch(e => {
            console.error('Lỗi lấy dữ liệu sản phẩm bán chạy:', e);
            alert('Không thể tải dữ liệu sản phẩm bán chạy!');
        });

    // Biểu đồ sản phẩm yêu thích với bảng màu sắc + tên to + tỉ lệ %
    fetch('@Url.Action("SanPhamYeuThich", "ThongKe", new { area = "Admin" })')
        .then(res => res.json())
        .then(data => {
            new Chart(document.getElementById('chartYeuThich'), {
                type: 'pie',
                data: {
                    labels: data.map(x => x.label),
                    datasets: [{
                        label: 'Số lượt yêu thích',
                        data: data.map(x => x.value),
                        backgroundColor: data.map((_, idx) => colors[idx % colors.length])
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: { font: { size: 16 } }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(1);
                                return percentage + '%';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            const tbody = document.querySelector('#favoriteTable tbody');
            tbody.innerHTML = '';

            data.forEach((item, idx) => {
                const tr = document.createElement('tr');

                const tdColor = document.createElement('td');
                const dot = document.createElement('span');
                dot.className = 'color-dot';
                dot.style.backgroundColor = colors[idx % colors.length];
                tdColor.appendChild(dot);

                const tdName = document.createElement('td');
                tdName.textContent = item.label;
                tdName.style.fontSize = '1.2rem';
                tdName.style.fontWeight = '600';

                const tdCount = document.createElement('td');
                tdCount.textContent = item.value;
                tdCount.style.fontWeight = '600';

                tr.appendChild(tdColor);
                tr.appendChild(tdName);
                tr.appendChild(tdCount);

                tbody.appendChild(tr);
            });

            $('#favoriteTable').DataTable({
                paging: true,
                searching: true,
                info: false,
                lengthChange: false,
                pageLength: 5,
                language: {
                    search: "Tìm kiếm:",
                    paginate: {
                        previous: "Trước",
                        next: "Tiếp"
                    },
                    zeroRecords: "Không tìm thấy kết quả"
                }
            });
        })
        .catch(e => {
            console.error('Lỗi lấy dữ liệu sản phẩm yêu thích:', e);
            alert('Không thể tải dữ liệu sản phẩm yêu thích!');
        });
</script>

<script src="~/Admin/js/jquery-3.6.0.min.js"></script>
<script src="~/Admin/js/feather.min.js"></script>
<script src="~/Admin/js/jquery.slimscroll.min.js"></script>
<script src="~/Admin/js/jquery.dataTables.min.js"></script>
<script src="~/Admin/js/dataTables.bootstrap4.min.js"></script>
<script src="~/Admin/js/bootstrap.bundle.min.js"></script>
<script src="~/Admin/plugins/select2/js/select2.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalerts.min.js"></script>
<script src="~/Admin/js/script.js"></script>
