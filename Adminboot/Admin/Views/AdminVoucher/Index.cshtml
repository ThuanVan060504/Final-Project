@model IEnumerable<Final_Project.Models.Shop.Voucher>

@{
    ViewData["Title"] = "Quản lý Voucher";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<link rel="shortcut icon" type="image/x-icon" href="~/Admin/img/favicon.jpg">

<link rel="stylesheet" href="~/Admin/css/bootstrap.min.css">

<link rel="stylesheet" href="~/Admin/css/animate.css">

<link rel="stylesheet" href="~/Admin/plugins/select2/css/select2.min.css">

<link rel="stylesheet" href="~/Admin/css/dataTables.bootstrap4.min.css">

<link rel="stylesheet" href="~/Admin/plugins/fontawesome/css/fontawesome.min.css">
<link rel="stylesheet" href="~/Admin/plugins/fontawesome/css/all.min.css">

<link rel="stylesheet" href="~/Admin/css/style.css">
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Danh sách Voucher</h4>
                <h6>Quản lý các mã giảm giá</h6>
            </div>
            @* ✅ DÒNG ĐÃ SỬA (Dùng Url.Action giống DanhmucSP) *@
            <div class="page-btn">
                <a href="@Url.Action("Create", "AdminVoucher", new { area = "Admin" })" class="btn btn-added">
                    <img src="~/Admin/img/icons/plus.svg" alt="img" class="me-1">Thêm Voucher mới
                </a>
            </div>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <strong>Thành công!</strong> @TempData["SuccessMessage"]
                <button type-button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Lỗi!</strong> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table datanew">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mã Code</th>
                                <th>Mô tả</th>
                                <th>Loại</th>
                                <th>Giá trị</th>
                                <th>Đơn tối thiểu</th>
                                <th>Hiệu lực</th>
                                <th>Đã dùng / Tổng</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.MaVoucherID</td>
                                    <td><strong>@item.MaCode</strong></td>
                                    <td>@item.MoTa</td>
                                    <td>
                                        @if (item.LoaiGiamGia == "PhanTram")
                                        {
                                            <span class="badge bg-lightgreen">Phần trăm</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-lightpurple">Số tiền</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.LoaiGiamGia == "PhanTram")
                                        {
                                            <span>@item.GiaTriGiam% (Tối đa: @item.GiamGiaToiDa?.ToString("N0"))</span>
                                        }
                                        else
                                        {
                                            <span>@item.GiaTriGiam.ToString("N0") đ</span>
                                        }
                                    </td>
                                    <td>@item.DonHangToiThieu.ToString("N0") đ</td>
                                    <td>@item.NgayBatDau.ToString("dd/MM/yy") - @item.NgayKetThuc.ToString("dd/MM/yy")</td>
                                    <td>@item.SoLuongDaDung / @(item.SoLuongToiDa?.ToString() ?? "∞")</td>
                                    <td>
                                        @if (item.IsActive && item.NgayKetThuc >= DateTime.Now)
                                        {
                                            <span class="badges bg-lightgreen">Hoạt động</span>
                                        }
                                        else
                                        {
                                            <span class="badges bg-lightred">Hết hạn</span>
                                        }
                                    </td>
                                    <td>
                                        @* ✅ DÒNG ĐÃ SỬA (Dùng href) *@
                                        <a class="me-3" href="/Admin/AdminVoucher/Edit/@item.MaVoucherID">
                                            <img src="~/Admin/img/icons/edit.svg" alt="img">
                                        </a>

                                        @* ✅ Sửa thành thẻ <a> với class "btn-delete" *@
                                        <a href="javascript:void(0);" class="me-3 btn-delete"
                                           data-id="@item.MaVoucherID"
                                           data-name="@item.MaCode">
                                            <img src="~/Admin/img/icons/delete.svg" alt="delete" />
                                        </a>
                                    </td>
                                </tr>
                            } 
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/Admin/js/jquery-3.6.0.min.js"></script>
<script src="~/Admin/js/feather.min.js"></script>
<script src="~/Admin/js/jquery.slimscroll.min.js"></script>
<script src="~/Admin/js/jquery.dataTables.min.js"></script>
<script src="~/Admin/js/dataTables.bootstrap4.min.js"></script>
<script src="~/Admin/js/bootstrap.bundle.min.js"></script>
<script src="~/Admin/plugins/select2/js/select2.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalerts.min.js"></script>
<script src="~/Admin/js/script.js"></script>
@section Scripts {
    <script>
        // ✅ Đây là script của DanhmucSP, nó gọi [HttpGet] Delete
        $(document).ready(function () {
            $(document).on('click', '.btn-delete', function () {
                var id = $(this).data('id');
                var name = $(this).data('name');
                Swal.fire({
                    title: 'Bạn có chắc chắn?',
                    text: "Bạn sẽ xóa voucher '" + name + "'!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Vâng, xóa nó!',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Gọi action [HttpGet] Delete (giống hệt DanhmucSP)
                        window.location.href = '/Admin/AdminVoucher/Delete/' + id;
                    }
                })
            });
        });
    </script>
}