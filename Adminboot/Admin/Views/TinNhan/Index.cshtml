@model Tuple<List<Final_Project.Models.User.TaiKhoan>, List<Final_Project.Models.Chat.TinNhan>>

@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Tin Nhắn";
    var users = Model.Item1;
    var messages = Model.Item2;
    int? currentUserId = ViewBag.UserId as int?;
    string currentUserName = ViewBag.UserName as string;
}

<link rel="stylesheet" href="~/Admin/css/bootstrap.min.css" />
<link rel="stylesheet" href="~/Admin/css/animate.css" />
<link rel="stylesheet" href="~/Admin/plugins/select2/css/select2.min.css" />
<link rel="stylesheet" href="~/Admin/css/dataTables.bootstrap4.min.css" />
<link rel="stylesheet" href="~/Admin/plugins/fontawesome/css/all.min.css" />
<link rel="stylesheet" href="~/Admin/css/style.css" />

<style>
    /* Avatar danh sách user */
    .user-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
        border: 2px solid transparent;
        transition: border-color 0.3s;
    }
    .list-group-item.active .user-avatar {
        border-color: #fff;
    }

    /* Chat container */
    .chat-container {
        border: 1px solid #ddd;
        border-radius: 6px;
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        background: #f9f9f9;
    }

    /* Tin nhắn bên gửi (admin) */
    .chat-message.admin {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 12px;
    }
    .chat-message.admin .message-bubble {
        background-color: #007bff;
        color: white;
        padding: 8px 15px;
        border-radius: 20px 20px 0 20px;
        max-width: 75%;
    }
    .chat-message.admin .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-left: 8px;
    }

    /* Tin nhắn bên nhận (user) */
    .chat-message.user {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }
    .chat-message.user .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 8px;
    }
    .chat-message.user .message-bubble {
        background-color: #28a745;
        color: white;
        padding: 8px 15px;
        border-radius: 20px 20px 20px 0;
        max-width: 75%;
    }

    .message-info {
        font-size: 0.75rem;
        color: #ccc;
        margin-top: 3px;
    }

    /* Danh sách user */
    .list-group-item.active {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
        font-weight: 600;
    }

    /* Form gửi tin */
    .chat-input-group input {
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
    }

    .chat-input-group button {
        border-top-right-radius: 20px;
        border-bottom-right-radius: 20px;
    }
</style>

<div class="page-wrapper">
    <div class="content">
        <div class="row">

            <!-- Danh sách user -->
            <div class="col-lg-4 mb-4">
                <h4>Danh sách người đã chat</h4>
                <ul class="list-group shadow-sm">
                    @foreach (var user in users)
                    {
                        var activeClass = (currentUserId.HasValue && user.MaTK == currentUserId) ? "active" : "";
                        <li class="list-group-item @activeClass d-flex align-items-center">
                            <a href="@Url.Action("Index", "TinNhan", new { area = "Admin", userId = user.MaTK })"
                               class="d-flex align-items-center text-decoration-none @((activeClass == "active") ? "text-white" : "")">
                                <img src="@(string.IsNullOrEmpty(user.Avatar) ? Url.Content("~/Admin/img/default-avatar.png") : user.Avatar)"
                                     alt="Avatar" class="user-avatar" />
                                <span>@user.HoTen</span>
                            </a>
                        </li>
                    }
                </ul>
            </div>

            <!-- Khung chat -->
            <div class="col-lg-8">
                @if (currentUserId.HasValue)
                {
                    <h4>Chat với @currentUserName</h4>

                    <div class="chat-container mb-3" id="chatBox">
                        @foreach (var msg in messages)
                        {
                            if (msg.NguoiGuiId == 3)
                            {
                                <div class="chat-message admin">
                                    <div class="message-bubble">
                                        <strong>Admin:</strong> @msg.NoiDung
                                        <div class="message-info">@msg.ThoiGianGui.ToString("HH:mm")</div>
                                    </div>
                                    <img src="@(Url.Content("~/Admin/img/admin-avatar.png"))" alt="Admin Avatar" class="avatar" />
                                </div>
                            }
                            else
                            {
                                <div class="chat-message user">
                                    <img src="@(string.IsNullOrEmpty(msg.NguoiGui?.Avatar) ? Url.Content("~/Admin/img/default-avatar.png") : msg.NguoiGui.Avatar)" alt="User Avatar" class="avatar" />
                                    <div class="message-bubble">
                                        <strong>@msg.NguoiGui?.HoTen:</strong> @msg.NoiDung
                                        <div class="message-info">@msg.ThoiGianGui.ToString("HH:mm")</div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <form action="@Url.Action("SendMessage", "TinNhan", new { area = "Admin" })" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="userId" value="@currentUserId" />
    <div class="input-group chat-input-group">
        <input type="text" name="noiDung" class="form-control" placeholder="Nhập tin nhắn..." autocomplete="off" required />
        <button type="submit" class="btn btn-primary">Gửi</button>
    </div>
</form>

                }
                else
                {
                    <h5 class="text-muted">Chọn một người dùng bên trái để bắt đầu chat</h5>
                }
            </div>

        </div>
    </div>
</div>

<script src="~/Admin/js/jquery-3.6.0.min.js"></script>
<script src="~/Admin/js/feather.min.js"></script>
<script src="~/Admin/js/jquery.slimscroll.min.js"></script>
<script src="~/Admin/js/jquery.dataTables.min.js"></script>
<script src="~/Admin/js/dataTables.bootstrap4.min.js"></script>
<script src="~/Admin/js/bootstrap.bundle.min.js"></script>
<script src="~/Admin/plugins/select2/js/select2.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script src="~/Admin/plugins/sweetalert/sweetalerts.min.js"></script>
<script src="~/Admin/js/script.js"></script>

<script>
    // Tự cuộn xuống cuối khi load chat
    $(document).ready(function () {
        var chatBox = $('#chatBox');
        chatBox.scrollTop(chatBox.prop("scrollHeight"));
    });
</script>
