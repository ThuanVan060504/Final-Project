@using Final_Project.Models.Shop
@{
    ViewData["Title"] = "Thông tin tài khoản";
    var taiKhoan = ViewBag.TaiKhoan as Final_Project.Models.User.TaiKhoan;
    var donHangs = Model as List<DonHang>;
    var yeuThichList = ViewBag.SanPhamYeuThich as List<SanPham> ?? new List<SanPham>();
    var myVouchers = ViewBag.MyVouchers as List<Voucher> ?? new List<Voucher>();
}


<link rel="stylesheet" href="~/css/canhan.css">

<style>
    :root {
        --main-orange: #ff9e4f;
        --main-orange-dark: #e88738;
    }
    /* Form thêm địa chỉ */
    #addForm input,
    #addForm select,
    #editAddressModal input,
    #editAddressModal select {
        border-radius: 6px;
        border: 1px solid #ccc;
        padding: 8px 12px;
        font-size: 0.95rem;
        width: 100%;
        transition: border-color 0.3s ease;
        margin-bottom: 10px; /* Thêm khoảng cách */
    }

        #addForm input:focus,
        #addForm select:focus,
        #editAddressModal input:focus,
        #editAddressModal select:focus {
            border-color: var(--main-orange);
            outline: none;
            box-shadow: 0 0 5px rgba(255,158,79,0.5);
        }

    #addForm button.btn-save-ghn,
    #editAddressModal button.btn-save-ghn {
        background-color: var(--main-orange);
        border-color: var(--main-orange);
        color: white;
        font-weight: 600;
        border-radius: 6px;
        padding: 6px 16px;
        transition: background-color 0.3s ease;
    }

    #editAddressModalBackdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1040;
    }
        #addForm button.btn-save-ghn:hover {
            background-color: var(--main-orange-dark);
        }
    /* ===== 1. CSS CHO MODAL "THÊM ĐỊA CHỈ" ===== */

    /* Lớp mờ nền (Backdrop) */
    #addAddressModalBackdrop {
        display: none; /* Ẩn ban đầu */
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.6); /* Lớp mờ */
        z-index: 1040; /* Dưới modal */
    }

    /* Sửa #addForm để thành Modal */
    #addForm, #editAddressModal {
        /* display: none; (đã có) */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 600px;
        width: 90%;
        max-height: 80vh; /* Cho phép cuộn */
        overflow-y: auto; /* Thêm cuộn */
        z-index: 1050; /* Trên lớp mờ */
        background: #fff;
        padding: 25px; /* Thêm padding */
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .address-buttons .address-btn.red {
        background-color: #dc3545; /* Màu đỏ */
        border-color: #dc3545;
        color: white;
    }

        .address-buttons .address-btn.red:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

    .my-voucher-list .voucher-item {
        display: flex; /* Dùng flex (dạng block) */
        width: 100%; /* Chiếm 100% chiều rộng */
        align-items: center;
        margin-bottom: 15px; /* Khoảng cách dọc */
        padding: 12px;
        border-radius: 8px;
        background-color: #fff4eb; /* Nền cam nhạt */
        border: 2px solid #ff9933; /* Viền cam đậm */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .my-voucher-list .voucher-image {
        flex-shrink: 0;
        margin-right: 15px;
    }

        .my-voucher-list .voucher-image img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
        }

    .my-voucher-list .voucher-content {
        flex-grow: 1; /* Cho phép text giãn ra */
        margin-right: 15px;
    }

        .my-voucher-list .voucher-content p {
            margin: 0;
            line-height: 1.4;
        }

        .my-voucher-list .voucher-content .voucher-code {
            font-size: 1.1em;
            font-weight: 700;
            color: #d9534f; /* Màu đỏ cam */
        }

        .my-voucher-list .voucher-content .voucher-desc {
            font-size: 0.9em;
            color: #555;
        }

    .my-voucher-list .voucher-action {
        margin-left: auto; /* Đẩy nút "Dùng ngay" về sát lề phải */
    }
</style>


<div id="addAddressModalBackdrop" onclick="toggleNewAddress()"></div>


<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <ul class="sidebar-menu">
                <li class="active" onclick="showSection('profileSection', this)">Thông tin cá nhân</li>
                <li id="historyTab" onclick="showSection('historySection', this)">Lịch sử mua hàng</li>
                <li onclick="showSection('addressSection', this)">Địa chỉ đặt hàng</li>
                <li onclick="showSection('favoritesSection', this)">Sản phẩm yêu thích</li>
                <li onclick="showSection('vouchersSection', this)">Voucher của tôi</li>
                <li onclick="showSection('changePasswordSection', this)">Đổi mật khẩu</li>
            </ul>
        </div>

        <div class="col-md-9">
            <div id="profileSection" class="content-section active">
                <h4 class="mb-3 text-success">Thông tin tài khoản</h4>
                <div class="text-center mb-4">
                    <img src="@(string.IsNullOrEmpty(taiKhoan?.Avatar) ? "/images/default-avatar.png" : taiKhoan.Avatar)"
                         alt="Avatar"
                         class="rounded-circle shadow"
                         style="width: 120px; height: 120px; object-fit: cover;" />
                </div>

                <form asp-action="UploadAvatar" asp-controller="User" method="post" enctype="multipart/form-data" class="text-center mb-4">
                    <input type="hidden" name="MaTK" value="@taiKhoan?.MaTK" />
                    <input type="file" name="avatarFile" class="form-control w-50 d-inline-block mb-2" accept="image/*" required />
                    <button type="submit" class="btn btn-outline-primary btn-sm">Đổi ảnh đại diện</button>
                </form>

                <div id="viewInfo">
                    <div class="border p-3 rounded shadow-sm mb-3">
                        <p><strong>Họ tên:</strong> @taiKhoan?.HoTen</p>
                        <p><strong>Email:</strong> @taiKhoan?.Email</p>
                        <p><strong>SĐT:</strong> @taiKhoan?.SDT</p>
                    </div>
                    <button class="btn btn-outline-success" onclick="toggleEdit(true)"> Chỉnh sửa</button>
                </div>

                <div id="editInfo" style="display:none;">
                    <form method="post" asp-action="UpdateProfile" asp-controller="User">
                        <input type="hidden" name="MaTK" value="@taiKhoan?.MaTK" />
                        <div class="mb-3">
                            <label class="form-label">Họ tên</label>
                            <input type="text" name="HoTen" class="form-control" value="@taiKhoan?.HoTen" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="Email" class="form-control" value="@taiKhoan?.Email" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" name="SDT" class="form-control" value="@taiKhoan?.SDT" required />
                        </div>
                        <button type="submit" class="btn btn-success">Lưu</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="toggleEdit(false)">❌ Hủy</button>
                    </form>
                </div>
            </div>


            <div id="historySection" class="content-section">
                <h4 class="mb-3 text-primary">Lịch sử mua hàng</h4>
                @if (donHangs != null && donHangs.Count > 0)
                {
                    foreach (var don in donHangs)
                    {
                        <div class="order-card shadow-sm rounded p-3 mb-4 border">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="fw-semibold">Đơn hàng #@don.MaDonHang</span> -
                                    <span class="text-muted">@don.NgayDat.ToString("dd/MM/yyyy")</span>
                                    <span class="text-muted">
                                        <strong>📍 Giao đến:</strong>
                                        @don.DiaChiNguoiDung.DiaChiChiTiet,
                                        @don.DiaChiNguoiDung.PhuongXa,
                                        @don.DiaChiNguoiDung.QuanHuyen,
                                        @don.DiaChiNguoiDung.TinhTP
                                    </span>
                                </div>
                                <div class="text-success fw-bold">🟢 @don.TrangThaiDonHang</div>
                            </div>
                            <div class="order-progress">
                                @{
                                    var trangThai = don.TrangThaiDonHang;
                                    var isCancelled = trangThai == "HuyDon";

                                    string[] steps = new[] { "ChoXacNhan", "DangXuLy", "DangGiao", "DaGiao" };

                                    foreach (var step in steps)
                                    {
                                        var isActive = steps.ToList().IndexOf(trangThai) >= steps.ToList().IndexOf(step);
                                        var isCancelledStep = isCancelled && step == trangThai;

                                        <div class="progress-step @(isCancelledStep ? "cancelled" : (isActive ? "active" : ""))">
                                            <div class="circle">@step.Substring(0, 2)</div>
                                            <span>@step</span>
                                        </div>
                                    }

                                    if (isCancelled && !steps.Contains(trangThai))
                                    {
                                        <div class="progress-step cancelled">
                                            <div class="circle">Hu</div>
                                            <span>HuyDon</span>
                                        </div>
                                    }
                                }
                            </div>

                            @{
                                var firstProduct = don.ChiTietDonHangs.FirstOrDefault();
                                var otherProducts = don.ChiTietDonHangs.Skip(1).ToList();
                            }

                            @if (firstProduct != null)
                            {
                                <div class="d-flex align-items-center border-top pt-3 mt-2">
                                    <img src="@firstProduct.SanPham.ImageURL" class="img-thumbnail me-3" style="width: 80px; height: 80px;" />
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">@firstProduct.SanPham.TenSP</div>
                                        <div class="text-muted">@firstProduct.SoLuong</div>
                                        <a asp-controller="SanPham" asp-action="Details" asp-route-id="@firstProduct.SanPham.MaSP" class="btn btn-sm btn-outline-primary mt-1"> Xem chi tiết</a>
                                    </div>
                                    <div class="text-end fw-semibold text-danger" style="white-space: nowrap;">
                                        @firstProduct.DonGia.ToString("N0") ₫
                                    </div>
                                </div>
                            }

                            @if (otherProducts.Count > 0)
                            {
                                var sectionId = $"orderItems_{don.MaDonHang}";
                                <div id="@sectionId" style="display:none;">
                                    @foreach (var ct in otherProducts)
                                    {
                                        <div class="d-flex align-items-center border-top pt-3 mt-2">
                                            <img src="@ct.SanPham.ImageURL" class="img-thumbnail me-3" style="width: 80px; height: 80px;" />
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold">@ct.SanPham.TenSP</div>
                                                <div class="text-muted">@ct.SoLuong</div>
                                                <a asp-controller="SanPham" asp-action="Details" asp-route-id="@ct.SanPham.MaSP" class="btn btn-sm btn-outline-primary mt-1"> Xem chi tiết</a>
                                            </div>
                                            <div class="text-end fw-semibold text-danger" style="white-space: nowrap;">
                                                @ct.DonGia.ToString("N0") ₫
                                            </div>
                                        </div>
                                    }
                                </div>
                                <button class="btn btn-link px-0 text-decoration-none text-primary" type="button"
                                        onclick="toggleOrderItems('@sectionId', this)">
                                    + Xem thêm (@otherProducts.Count sản phẩm)
                                </button>
                            }


                            <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-3">
                                <div class="text-muted">Thanh toán: @don.TrangThaiThanhToan</div>
                                <div class="fw-bold">Tổng tiền: <span class="text-danger">@don.TongTien.ToString("N0") ₫</span></div>
                                @if (don.TrangThaiDonHang == "ChoXacNhan" || don.TrangThaiDonHang == "DangXuLy")
                                {
                                    <form asp-controller="DonHang" asp-action="HuyDon" method="post" onsubmit="return confirm('Bạn có chắc muốn hủy đơn hàng này không?');">
                                        <input type="hidden" name="maDonHang" value="@don.MaDonHang" />
                                        <button type="submit" class="btn btn-outline-danger mt-2">Hủy đơn hàng</button>
                                    </form>
                                }

                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Bạn chưa có đơn hàng nào được ghi nhận.</p>
                }
            </div>

            <div id="addressSection" class="content-section">
                <h4 class="mb-3 text-warning">Địa chỉ đặt hàng</h4>

                @if (taiKhoan != null && taiKhoan.DiaChiNguoiDungs != null && taiKhoan.DiaChiNguoiDungs.Count > 0)
                {
                    foreach (var diaChi in taiKhoan.DiaChiNguoiDungs)
                    {

                        <div class="border rounded p-3 mb-3 @(diaChi.MacDinh ? "border-success" : "")">
                            <div><strong>Họ tên:</strong> @diaChi.TenNguoiNhan</div>
                            <div><strong>Số điện thoại:</strong> @diaChi.SoDienThoai</div>
                            <div><strong>Địa chỉ:</strong> @diaChi.DiaChiChiTiet</div>
                            <div><strong>Phường/Xã:</strong> @diaChi.PhuongXa</div>
                            <div><strong>Quận/Huyện:</strong> @diaChi.QuanHuyen</div>
                            <div><strong>Tỉnh/TP:</strong> @diaChi.TinhTP</div>

                            @if (diaChi.MacDinh)
                            {
                                <div class="badge bg-success mt-2">Địa chỉ mặc định</div>
                            }
                            else
                            {
                                <div class="address-buttons mt-3">
                                    <form asp-controller="DiaChi" asp-action="SetDefault" method="post">
                                        <input type="hidden" name="id" value="@diaChi.MaDiaChi" />
                                        <button type="submit" class="address-btn blue">Chọn làm mặc định</button>
                                    </form>


                                    <button type="button" class="address-btn orange" onclick="openEditModal(@diaChi.MaDiaChi)"> Sửa</button>
                                    <button type="button" class="address-btn red" onclick="deleteAddress(@diaChi.MaDiaChi)">Xóa</button>
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Bạn chưa có địa chỉ nào.</p>
                }

                <button class="btn btn-outline-warning" type="button" onclick="toggleNewAddress()">Thêm địa chỉ mới</button>
                <hr />

                <div id="editAddressModalBackdrop" onclick="toggleEditAddress()"></div>
                <div id="addForm" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h5 style="margin: 0; font-weight: 600;">Thêm địa chỉ mới</h5>
                        <button type="button" class="btn-close" onclick="toggleNewAddress()"></button>
                    </div>

                    <div class="mb-2"><input type="text" class="form-control" id="newName" placeholder="Họ tên"></div>
                    <div class="mb-2"><input type="text" class="form-control" id="newPhone" placeholder="Số điện thoại"></div>

                    <div class="mb-2">
                        <select id="ghnProvinceSelect" class="form-control">
                            <option value="">Vui lòng chọn Tỉnh/Thành</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <select id="ghnDistrictSelect" class="form-control" disabled>
                            <option value="">Vui lòng chọn Quận/Huyện</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <select id="ghnWardSelect" class="form-control" disabled>
                            <option value="">Vui lòng chọn Phường/Xã</option>
                        </select>
                    </div>

                    <div class="mb-2"><input type="text" class="form-control" id="newAddr" placeholder="Địa chỉ chi tiết (Số nhà, tên đường...)"></div>

                    <div class="mt-3">
                        <button class="btn btn-save-ghn" type="button" onclick="saveNewAddress()">Lưu địa chỉ</button>
                        <button class="btn btn-secondary" type="button" onclick="toggleNewAddress()" style="margin-left: 10px;">Hủy</button>
                    </div>
                </div>
                <div id="editAddressModal" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h5 style="margin: 0; font-weight: 600;">Chỉnh sửa địa chỉ</h5>
                        <button type="button" class="btn-close" onclick="toggleEditAddress()"></button>
                    </div>

                    <input type="hidden" id="editMaDiaChi" />

                    <div class="mb-2"><input type="text" class="form-control" id="editName" placeholder="Họ tên"></div>
                    <div class="mb-2"><input type="text" class="form-control" id="editPhone" placeholder="Số điện thoại"></div>

                    <div class="mb-2">
                        <select id="editProvinceSelect" class="form-control" disabled>
                            <option value="">Đang tải Tỉnh/Thành...</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <select id="editDistrictSelect" class="form-control" disabled>
                            <option value="">Vui lòng chọn Tỉnh/Thành</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <select id="editWardSelect" class="form-control" disabled>
                            <option value="">Vui lòng chọn Quận/Huyện</option>
                        </select>
                    </div>

                    <div class="mb-2"><input type="text" class="form-control" id="editAddr" placeholder="Địa chỉ chi tiết (Số nhà, tên đường...)"></div>

                    <div class="mt-3">
                        <button class="btn btn-save-ghn" type="button" onclick="saveEditAddress()">Lưu thay đổi</button>
                        <button class="btn btn-secondary" type="button" onclick="toggleEditAddress()" style="margin-left: 10px;">Hủy</button>
                    </div>
                </div>
            </div>

            <div id="favoritesSection" class="content-section">
                <h4 class="mb-3 fw-bold">Danh sách yêu thích</h4>

                @if (yeuThichList == null || !yeuThichList.Any())
                {
                    <div class="alert alert-info">Bạn chưa thêm sản phẩm nào vào danh sách yêu thích.</div>
                }
                else
                {
                    <div class="row justify-content-center row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                        @foreach (var sp in yeuThichList)
                        {
                            <div class="col-auto">
                                <div class="card h-100 product-card">
                                    <div class="position-relative">
                                        <img src="@sp.ImageURL" class="card-img-top" style="height: 180px; object-fit: cover;" />
                                        <span class="favorite-icon">❤️</span>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h6 class="fw-semibold">@sp.TenSP</h6>
                                        <p class="product-price">@sp.DonGia.ToString("N0") đ</p>

                                        <div class="button-group mt-auto">
                                            <a asp-controller="SanPham" asp-action="Details" asp-route-id="@sp.MaSP" class="custom-btn green">Xem chi tiết</a>

                                            <form asp-controller="YeuThich" asp-action="BoYeuThich" method="post" style="margin: 0;">
                                                <input type="hidden" name="maSP" value="@sp.MaSP" />
                                                <button type="submit" class="custom-btn red">Bỏ yêu thích</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div id="changePasswordSection" class="content-section" style="display: none;">
                <h4 class="mb-3 fw-bold text-orange">Đổi mật khẩu</h4>

                <form asp-controller="User" asp-action="DoiMatKhau" method="post" class="password-form">
                    <div class="form-group mb-3">
                        <label for="OldPassword">Mật khẩu hiện tại</label>
                        <input type="password" class="form-control" name="OldPassword" placeholder="Nhập mật khẩu hiện tại" required />
                    </div>
                    <div class="form-group mb-3">
                        <label for="NewPassword">Mật khẩu mới</label>
                        <input type="password" class="form-control" name="NewPassword" placeholder="Nhập mật khẩu mới" required />
                    </div>
                    <div class="form-group mb-4">
                        <label for="ConfirmPassword">Xác nhận mật khẩu mới</label>
                        <input type="password" class="form-control" name="ConfirmPassword" placeholder="Xác nhận mật khẩu mới" required />
                    </div>
                    <button type="submit" class="custom-btn orange w-100">Đổi mật khẩu</button>
                </form>

                @if (TempData["PasswordChangeMessage"] != null)
                {
                    <div class="alert alert-info mt-3">@TempData["PasswordChangeMessage"]</div>
                }
            </div>
            <div id="vouchersSection" class="content-section" style="display: none;">
                <h4 class="mb-3 fw-bold text-orange">Voucher của tôi</h4>

                @if (!myVouchers.Any())
                {
                    <div class="alert alert-info">Bạn chưa lưu voucher nào. Hãy quay lại trang chủ để săn thêm voucher nhé!</div>
                }
                else
                {
                    <div class="my-voucher-list">
                        @foreach (var voucher in myVouchers)
                        {
                            <div class="voucher-item">
                                <div class="voucher-image">
                                    <img src="~/images/G3TD_Ship.png" alt="Voucher">
                                </div>
                                <div class="voucher-content">
                                    <p class="voucher-code">@voucher.MaCode</p>
                                    <p class="voucher-desc">
                                        @voucher.MoTa - HSD: @voucher.NgayKetThuc.ToString("dd/MM/yyyy")
                                    </p>
                                </div>
                                <div class="voucher-action">
                                    <a asp-controller="Home" asp-action="Index" class="btn btn-danger btn-sm">Dùng ngay</a>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
            <div id="changePasswordSection" class="content-section" style="display: none;">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // === HÀM VỪA DI CHUYỂN TỪ TRÊN XUỐNG ===
        function toggleEdit(showEdit) {
            document.getElementById("viewInfo").style.display = showEdit ? "none" : "block";
            document.getElementById("editInfo").style.display = showEdit ? "block" : "none";
        }

        // === SCRIPT GỐC CỦA TRANG ===
        function toggleOrderItems(sectionId, btn) {
            const section = document.getElementById(sectionId);
            const isHidden = getComputedStyle(section).display === "none";
            section.style.display = isHidden ? "block" : "none";
            btn.innerText = isHidden ? "Ẩn bớt" : "+ Xem thêm";
        }

        // === SCRIPT ĐIỀU KHIỂN MODAL (ĐÃ SỬA) ===
        let ghnProvincesLoaded = false;
        async function toggleNewAddress() { // <-- Sửa: Thêm async
            const form = document.getElementById("addForm");
            const backdrop = document.getElementById("addAddressModalBackdrop");
            const isHidden = getComputedStyle(form).display === "none";

            form.style.display = isHidden ? "block" : "none";
            backdrop.style.display = isHidden ? "block" : "none";
            document.body.style.overflow = isHidden ? "hidden" : "auto";

            if (form.style.display === 'block' && !ghnProvincesLoaded) {
                // Sửa: Gọi hàm loadProvinces tái sử dụng
                await loadProvinces(ghnProvinceSelect);
                ghnProvincesLoaded = true;
            }
        }
        // === BẮT ĐẦU THÊM MỚI: HÀM CHO MODAL SỬA ===
        function toggleEditAddress() {
            const form = document.getElementById("editAddressModal");
            const backdrop = document.getElementById("editAddressModalBackdrop");
            const isHidden = getComputedStyle(form).display === "none";

            form.style.display = isHidden ? "block" : "none";
            backdrop.style.display = isHidden ? "block" : "none";
            document.body.style.overflow = isHidden ? "hidden" : "auto";
        }
        // === KẾT THÚC THÊM MỚI ===
        // Đây là hàm showSection DUY NHẤT VÀ CHÍNH XÁC
        function showSection(id, el) {
            document.querySelectorAll('.content-section').forEach(sec => sec.style.display = 'none');
            document.getElementById(id).style.display = 'block';

            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            if (el) { // Thêm kiểm tra el tồn tại
                 el.classList.add('active');
            }
        }

        window.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const fragment = urlParams.get('fragment') || "profileSection"; // Mặc định là profile

            let targetElement = document.querySelector(`li[onclick*="${fragment}"]`);
            showSection(fragment, targetElement);
        });

    </script>

    <script>
        // --- CÀI ĐẶT API GHN ---
        const GHN_TOKEN = "c8dd5606-b8d8-11f0-b040-4e257d8388b4"; // Token của bạn
        const GHN_SHOP_ID = 197908; // Shop ID của bạn (dạng SỐ)
        const GHN_API_MASTER_DATA = "https://dev-online-gateway.ghn.vn/shiip/public-api/master-data";

        // --- LẤY DOM ELEMENTS CHO FORM THÊM ĐỊA CHỈ ---
        const ghnProvinceSelect = document.getElementById('ghnProvinceSelect');
        const ghnDistrictSelect = document.getElementById('ghnDistrictSelect');
        const ghnWardSelect = document.getElementById('ghnWardSelect');
        // Form Sửa (Edit)
        const editProvinceSelect = document.getElementById('editProvinceSelect');
        const editDistrictSelect = document.getElementById('editDistrictSelect');
        const editWardSelect = document.getElementById('editWardSelect');
        /**
         * Hàm gọi API GHN (Chung)
         */
        async function ghnApiCall(endpoint, options = {}, apiBase = GHN_API_MASTER_DATA) {
            try {
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    'Token': GHN_TOKEN,
                    'ShopId': GHN_SHOP_ID
                };

                const config = {
                    method: 'GET', ...options,
                    headers: { ...defaultHeaders, ...(options.headers || {}) }
                };

                const response = await fetch(`${apiBase}${endpoint}`, config);

                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData && errorData.code_message_value) {
                        throw new Error(errorData.code_message_value);
                    }
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.code !== 200) {
                     throw new Error(result.message || 'Lỗi không xác định từ GHN');
                }
                return result.data;

            } catch (error) {
                console.error('Lỗi khi gọi API GHN:', error.message);
                alert(`Lỗi API GHN: ${error.message}. Vui lòng kiểm tra lại Token/ShopID.`);
                return null;
            }
        }

        /**
         * HÀM TÁI SỬ DỤNG: Tải Tỉnh/Thành
         * selectEl: Element <select> của tỉnh
         * selectedId: ID của tỉnh cần được chọn (dùng cho form Sửa)
         */
        async function loadProvinces(selectEl, selectedId = null) {
            selectEl.innerHTML = '<option value="">Đang tải Tỉnh/Thành...</option>';
            selectEl.disabled = true;
            const provinces = await ghnApiCall('/province');
            if (provinces) {
                selectEl.innerHTML = '<option value="">--- Chọn Tỉnh/Thành ---</option>';
                provinces.sort((a, b) => a.ProvinceName.localeCompare(b.ProvinceName));
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.ProvinceID;
                    option.textContent = province.ProvinceName;
                    selectEl.appendChild(option);
                });

                if (selectedId) {
                    selectEl.value = selectedId; // Chọn Tỉnh đã lưu
                }
                selectEl.disabled = false;
            } else {
                 selectEl.innerHTML = '<option value="">Lỗi tải Tỉnh/Thành</option>';
            }
        }

        /**
         * HÀM TÁI SỬ DỤNG: Tải Quận/Huyện
         * provinceId: ID của tỉnh đã chọn
         * selectEl: Element <select> của quận
         * selectedId: ID của quận cần được chọn (dùng cho form Sửa)
         */
        async function loadDistricts(provinceId, selectEl, selectedId = null) {
            if (!provinceId) {
                selectEl.innerHTML = '<option value="">Vui lòng chọn Tỉnh/Thành</option>';
                selectEl.disabled = true;
                return;
            }
            selectEl.innerHTML = '<option value="">Đang tải Quận/Huyện...</option>';
            selectEl.disabled = true;

            const districts = await ghnApiCall(`/district?province_id=${provinceId}`);
            if (districts) {
                selectEl.innerHTML = '<option value="">--- Chọn Quận/Huyện ---</option>';
                districts.sort((a, b) => a.DistrictName.localeCompare(b.DistrictName));
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.DistrictID;
                    option.textContent = district.DistrictName;
                    selectEl.appendChild(option);
                });

                if (selectedId) {
                    selectEl.value = selectedId; // Chọn Quận đã lưu
                }
                selectEl.disabled = false;
            } else {
                 selectEl.innerHTML = '<option value="">Lỗi tải Quận/Huyện</option>';
            }
        }

        /**
         * HÀM TÁI SỬ DỤNG: Tải Phường/Xã
         * districtId: ID của quận đã chọn
         * selectEl: Element <select> của phường
         * selectedCode: Code của phường cần được chọn (dùng cho form Sửa)
         */
        async function loadWards(districtId, selectEl, selectedCode = null) {
             if (!districtId) {
                selectEl.innerHTML = '<option value="">Vui lòng chọn Quận/Huyện</option>';
                selectEl.disabled = true;
                return;
            }
            selectEl.innerHTML = '<option value="">Đang tải Phường/Xã...</option>';
            selectEl.disabled = true;

            const wards = await ghnApiCall(`/ward?district_id=${districtId}`);
            if (wards) {
                selectEl.innerHTML = '<option value="">--- Chọn Phường/Xã ---</option>';
                wards.sort((a, b) => a.WardName.localeCompare(b.WardName));
                wards.forEach(ward => {
                    const option = document.createElement('option');
                    option.value = ward.WardCode;
                    option.textContent = ward.WardName;
                    selectEl.appendChild(option);
                });

                if (selectedCode) {
                    selectEl.value = selectedCode; // Chọn Phường đã lưu
                }
                selectEl.disabled = false;
            } else {
                 selectEl.innerHTML = '<option value="">Lỗi tải Phường/Xã</option>';
            }
        }

        // --- Gắn sự kiện cho FORM THÊM MỚI ---
        ghnProvinceSelect.addEventListener('change', async (e) => {
            const provinceId = e.target.value;
            ghnWardSelect.innerHTML = '<option value="">Vui lòng chọn Quận/Huyện</option>';
            ghnWardSelect.disabled = true;
            await loadDistricts(provinceId, ghnDistrictSelect); // Tải quận cho form Thêm
        });

        ghnDistrictSelect.addEventListener('change', async (e) => {
            const districtId = e.target.value;
            await loadWards(districtId, ghnWardSelect); // Tải phường cho form Thêm
        });

        // --- Gắn sự kiện cho FORM SỬA ---
        editProvinceSelect.addEventListener('change', async (e) => {
            const provinceId = e.target.value;
            editWardSelect.innerHTML = '<option value="">Vui lòng chọn Quận/Huyện</option>';
            editWardSelect.disabled = true;
            await loadDistricts(provinceId, editDistrictSelect); // Tải quận cho form Sửa
        });

        editDistrictSelect.addEventListener('change', async (e) => {
            const districtId = e.target.value;
            await loadWards(districtId, editWardSelect); // Tải phường cho form Sửa
        });

        /**
         * Lưu địa chỉ mới
         */
        async function saveNewAddress() {
            // 1. Thu thập dữ liệu
            const tenNguoiNhan = document.getElementById('newName').value.trim();
            const soDienThoai = document.getElementById('newPhone').value.trim();
            const diaChiChiTiet = document.getElementById('newAddr').value.trim();
            const provinceID = ghnProvinceSelect.value;
            const provinceName = ghnProvinceSelect.options[ghnProvinceSelect.selectedIndex].text;
            const districtID = ghnDistrictSelect.value;
            const districtName = ghnDistrictSelect.options[ghnDistrictSelect.selectedIndex].text;
            const wardCode = ghnWardSelect.value;
            const wardName = ghnWardSelect.options[ghnWardSelect.selectedIndex].text;

            // 2. Kiểm tra dữ liệu
            if (!tenNguoiNhan || !soDienThoai || !diaChiChiTiet || !provinceID || !districtID || !wardCode) {
                alert("Vui lòng điền đầy đủ thông tin địa chỉ.");
                return;
            }

            // 3. Chuẩn bị dữ liệu gửi đi (khớp với DiaChiMoiViewModel)
            const data = {
                TenNguoiNhan: tenNguoiNhan,
                SoDienThoai: soDienThoai,
                DiaChiChiTiet: diaChiChiTiet,
                ProvinceID: parseInt(provinceID),
                ProvinceName: provinceName,
                DistrictID: parseInt(districtID),
                DistrictName: districtName,
                WardCode: wardCode,
                WardName: wardName
            };

            // 4. Gửi lên server
            try {
                // SỬA LỖI: Gọi đến /User/ThemDiaChiMoi
                const response = await fetch('/User/ThemDiaChiMoi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert("Thêm địa chỉ mới thành công!");
                    // SỬA LỖI: Tải lại trang và trỏ về đúng tab
                    location.href = '/User/Profile?fragment=addressSection';
                } else {
                    alert(result.message || "Lưu địa chỉ thất bại.");
                }
            } catch (error) {
                console.error("Lỗi khi lưu địa chỉ:", error);
                alert("Lỗi kết nối khi lưu địa chỉ.");
            }
        }
        // === BẮT ĐẦU THÊM MỚI: HÀM MỞ MODAL SỬA ===
        async function openEditModal(id) {
            // 1. Hiển thị modal
            toggleEditAddress();

            // 2. Reset và vô hiệu hóa form
            document.getElementById('editName').value = 'Đang tải...';
            document.getElementById('editPhone').value = 'Đang tải...';
            document.getElementById('editAddr').value = 'Đang tải...';
            editProvinceSelect.innerHTML = '<option value="">Đang tải...</option>';
            editDistrictSelect.innerHTML = '<option value="">Đang tải...</option>';
            editWardSelect.innerHTML = '<option value="">Đang tải...</option>';
            editProvinceSelect.disabled = true;
            editDistrictSelect.disabled = true;
            editWardSelect.disabled = true;

            // 3. Gọi API lấy chi tiết địa chỉ
            try {
                const response = await fetch(`/User/GetDiaChiDetails?id=${id}`);
                if (!response.ok) {
                    throw new Error('Không thể tải thông tin địa chỉ.');
                }
                const data = await response.json();

                // 4. Điền thông tin vào form
                document.getElementById('editMaDiaChi').value = data.maDiaChi;
                document.getElementById('editName').value = data.tenNguoiNhan;
                document.getElementById('editPhone').value = data.soDienThoai;
                document.getElementById('editAddr').value = data.diaChiChiTiet;

                // 5. Tải đồng bộ Tỉnh -> Quận -> Huyện (Đây là phần quan trọng)
                // Phải 'await' từng bước để đảm bảo thứ tự
                await loadProvinces(editProvinceSelect, data.provinceID);
                await loadDistricts(data.provinceID, editDistrictSelect, data.districtID);
                await loadWards(data.districtID, editWardSelect, data.wardCode);

            } catch (error) {
                console.error("Lỗi khi mở modal sửa:", error);
                alert(error.message);
                toggleEditAddress(); // Ẩn modal nếu lỗi
            }
        }

        // === BẮT ĐẦU THÊM MỚI: HÀM LƯU THAY ĐỔI ĐỊA CHỈ ===
        async function saveEditAddress() {
             // 1. Thu thập dữ liệu từ form Sửa
            const maDiaChi = document.getElementById('editMaDiaChi').value;
            const tenNguoiNhan = document.getElementById('editName').value.trim();
            const soDienThoai = document.getElementById('editPhone').value.trim();
            const diaChiChiTiet = document.getElementById('editAddr').value.trim();
            const provinceID = editProvinceSelect.value;
            const provinceName = editProvinceSelect.options[editProvinceSelect.selectedIndex].text;
            const districtID = editDistrictSelect.value;
            const districtName = editDistrictSelect.options[editDistrictSelect.selectedIndex].text;
            const wardCode = editWardSelect.value;
            const wardName = editWardSelect.options[editWardSelect.selectedIndex].text;

            // 2. Kiểm tra
            if (!tenNguoiNhan || !soDienThoai || !diaChiChiTiet || !provinceID || !districtID || !wardCode) {
                alert("Vui lòng điền đầy đủ thông tin địa chỉ.");
                return;
            }

             // 3. Chuẩn bị dữ liệu (khớp với DiaChiEditViewModel)
            const data = {
                MaDiaChi: parseInt(maDiaChi),
                TenNguoiNhan: tenNguoiNhan,
                SoDienThoai: soDienThoai,
                DiaChiChiTiet: diaChiChiTiet,
                ProvinceID: parseInt(provinceID),
                ProvinceName: provinceName,
                DistrictID: parseInt(districtID),
                DistrictName: districtName,
                WardCode: wardCode,
                WardName: wardName
            };

            // 4. Gửi lên server
            try {
                // Gọi action UpdateDiaChi
                const response = await fetch('/User/UpdateDiaChi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert("Cập nhật địa chỉ thành công!");
                    location.href = '/User/Profile?fragment=addressSection';
                } else {
                    alert(result.message || "Cập nhật địa chỉ thất bại.");
                }
            } catch (error) {
                console.error("Lỗi khi cập nhật địa chỉ:", error);
                alert("Lỗi kết nối khi cập nhật địa chỉ.");
            }
        }
                async function deleteAddress(id) {
            // 1. Hiển thị xác nhận
            if (!confirm('Bạn có chắc chắn muốn xóa địa chỉ này không?')) {
                return;
            }

            // 2. Gửi yêu cầu xóa lên server
            try {
                // Lưu ý: Dùng POST và gửi ID qua query string
                const response = await fetch(`/User/DeleteDiaChi?id=${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    // Tải lại trang và trỏ về đúng tab địa chỉ
                    location.href = '/User/Profile?fragment=addressSection';
                } else {
                    alert(result.message || "Xóa địa chỉ thất bại.");
                }
            } catch (error) {
                console.error("Lỗi khi xóa địa chỉ:", error);
                alert("Lỗi kết nối khi xóa địa chỉ.");
            }
        }

         //SCRIPT xử lý icon section Profile
        // Dùng 'window.onload' để đợi mọi thứ tải xong (quan trọng)
        window.addEventListener('load', function() {

            // Hàm này kích hoạt tab dựa trên # trong URL
            function activateTabFromUrl() {

                // 1. Lấy hash, ví dụ: #historySection hoặc #addressSection
                const currentHash = window.location.hash;
                if (!currentHash) return; // Không có hash, dùng tab mặc định

                // 2. Lấy sectionId, ví dụ: "addressSection"
                const sectionId = currentHash.substring(1);

                // 3. Tự động tạo ra Tab ID, ví dụ: "addressTab"
                // (Đây là lý do chúng ta thêm id="addressTab", "historyTab", v.v.)
                const tabId = sectionId.replace('Section', 'Tab');

                console.log(`Đang tìm tab cho: ${sectionId} (ID: ${tabId})`);

                // 4. Tìm LI (tab) bằng ID (Cách đáng tin cậy nhất)
                let targetLi = document.getElementById(tabId);

                // 5. Nếu không tìm thấy ID, thử tìm bằng [onclick] (Cách dự phòng)
                if (!targetLi) {
                    console.warn(`Không tìm thấy ID: ${tabId}. Đang thử tìm bằng onclick...`);
                    targetLi = document.querySelector(`.sidebar-menu li[onclick*="'${sectionId}'"]`);
                }

                // 6. Nếu tìm thấy, giả lập một cú click
                if (targetLi) {
                    console.log("Đã tìm thấy tab, đang kích hoạt click...");
                    targetLi.click(); // Giả lập click vào tab
                } else {
                    console.warn(`KHÔNG THỂ TÌM THẤY tab nào cho section: ${sectionId}`);
                }
            }

            // 7. Gọi hàm khi tải trang
            activateTabFromUrl();

            // 8. Gọi lại hàm khi hash thay đổi (người dùng bấm back/forward)
            window.addEventListener('hashchange', activateTabFromUrl);
        });       
        </script>
}