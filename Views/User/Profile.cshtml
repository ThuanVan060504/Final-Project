@using Final_Project.Models.Shop
@{
    ViewData["Title"] = "Thông tin tài khoản";
    var taiKhoan = ViewBag.TaiKhoan as Final_Project.Models.User.TaiKhoan;
    var donHangs = Model as List<DonHang>;
}


<!-- ✅ CSS ngay trong file -->
<style>
    .sidebar-menu {
        list-style: none;
        padding: 0;
    }

        .sidebar-menu li {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

            .sidebar-menu li.active,
            .sidebar-menu li:hover {
                background-color: #198754;
                color: white;
                font-weight: bold;
            }

    .content-section {
        display: none;
    }

        .content-section.active {
            display: block;
        }

    .history-box {
        border: 1px solid #ced4da;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #ffffff;
    }

    .order-item {
        margin-left: 15px;
    }

    .order-card {
        background-color: #fff;
        transition: box-shadow 0.3s;
    }

        .order-card:hover {
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

    .order-progress {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        position: relative;
        padding: 0 10px;
    }

        .order-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 4px;
            background-color: #dee2e6;
            z-index: 0;
        }

    .progress-step {
        position: relative;
        z-index: 1;
        text-align: center;
        flex: 1;
    }

        .progress-step .circle {
            width: 25px;
            height: 25px;
            line-height: 25px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: white;
            margin: 0 auto;
            font-size: 13px;
        }

        .progress-step.active .circle {
            background-color: #198754;
        }

        .progress-step.cancelled .circle {
            background-color: #dc3545;
        }

        .progress-step span {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #6c757d;
        }

        .progress-step.active span {
            color: #198754;
            font-weight: bold;
        }

        .progress-step.cancelled span {
            color: #dc3545;
            font-weight: bold;
        }
        .button-group {
    display: flex;
    gap: 10px;
    margin-top: auto;
}

.custom-btn {
    flex: 1;
    padding: 8px 12px;
    text-align: center;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.custom-btn.green {
    background-color: #198754;
    color: white;
}

.custom-btn.green:hover {
    background-color: #146c43;
}

.custom-btn.red {
    background-color: #dc3545;
    color: white;
}

.custom-btn.red:hover {
    background-color: #b02a37;
}
.address-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.address-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    color: white;
    transition: background-color 0.3s ease;
}

.address-btn.blue {
    background-color: #0d6efd;
}

.address-btn.blue:hover {
    background-color: #0b5ed7;
}

.address-btn.orange {
    background-color: #ffc107;
    color: black;
}

.address-btn.orange:hover {
    background-color: #e0a800;
}

</style>

<!-- ✅ Script để chuyển đổi nội dung -->
<script>
    function showSection(id, element) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        element.classList.add('active');
    }

    function toggleEdit(showEdit) {
        document.getElementById("viewInfo").style.display = showEdit ? "none" : "block";
        document.getElementById("editInfo").style.display = showEdit ? "block" : "none";
    }
</script>


<div class="container mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <ul class="sidebar-menu">
                <li class="active" onclick="showSection('profileSection', this)">🧍 Thông tin cá nhân</li>
                <li onclick="showSection('historySection', this)">📜 Lịch sử mua hàng</li>
                <li onclick="showSection('addressSection', this)">📍 Địa chỉ đặt hàng</li>
                <li onclick="showSection('favoritesSection', this)">❤️ Sản phẩm yêu thích</li>
                <li onclick="showSection('changePasswordSection', this)">🔐 Đổi mật khẩu</li>
            </ul>
        </div>

        <!-- Nội dung -->
        <div class="col-md-9">
            <!-- Thông tin cá nhân -->
            <div id="profileSection" class="content-section active">
                <h4 class="mb-3 text-success">👤 Thông tin tài khoản</h4>
                <div class="text-center mb-4">
    <img src="@(string.IsNullOrEmpty(taiKhoan?.Avatar) ? "imagesdefault-avatar.png" : taiKhoan.Avatar)"
         alt="Avatar"
         class="rounded-circle shadow"
         style="width: 120px; height: 120px; object-fit: cover;" />
</div>

<form asp-action="UploadAvatar" asp-controller="User" method="post" enctype="multipart/form-data" class="text-center mb-4">
    <input type="hidden" name="MaTK" value="@taiKhoan?.MaTK" />
    <input type="file" name="avatarFile" class="form-control w-50 d-inline-block mb-2" accept="image/*" required />
    <button type="submit" class="btn btn-outline-primary btn-sm">📤 Đổi ảnh đại diện</button>
</form>

                <div id="viewInfo">
                    <div class="border p-3 rounded shadow-sm mb-3">
                        <p><strong>Họ tên:</strong> @taiKhoan?.HoTen</p>
                        <p><strong>Email:</strong> @taiKhoan?.Email</p>
                        <p><strong>SĐT:</strong> @taiKhoan?.SDT</p>
                    </div>
                    <button class="btn btn-outline-success" onclick="toggleEdit(true)">✏️ Chỉnh sửa</button>
                </div>

                <div id="editInfo" style="display:none;">
                    <form method="post" asp-action="UpdateProfile" asp-controller="User">
                        <input type="hidden" name="MaTK" value="@taiKhoan?.MaTK" />
                        <div class="mb-3">
                            <label class="form-label">Họ tên</label>
                            <input type="text" name="HoTen" class="form-control" value="@taiKhoan?.HoTen" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="Email" class="form-control" value="@taiKhoan?.Email" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" name="SDT" class="form-control" value="@taiKhoan?.SDT" required />
                        </div>
                        <button type="submit" class="btn btn-success">💾 Lưu</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="toggleEdit(false)">❌ Hủy</button>
                    </form>
                </div>
            </div>


            <!-- Lịch sử mua hàng -->
            <div id="historySection" class="content-section">
                <h4 class="mb-3 text-primary">🛒 Lịch sử mua hàng</h4>
                @if (donHangs != null && donHangs.Count > 0)
                {
                    foreach (var don in donHangs)
                    {
                        <div class="order-card shadow-sm rounded p-3 mb-4 border">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="fw-semibold">Đơn hàng #@don.MaDonHang</span> -
                                    <span class="text-muted">@don.NgayDat.ToString("dd/MM/yyyy")</span>
                                     <span class="text-muted">
        <strong>📍 Giao đến:</strong>
        @don.DiaChiNguoiDung.DiaChiChiTiet,
        @don.DiaChiNguoiDung.PhuongXa,
        @don.DiaChiNguoiDung.QuanHuyen,
        @don.DiaChiNguoiDung.TinhTP
    </span>
                                </div>
                                <div class="text-success fw-bold">🟢 @don.TrangThaiDonHang</div>
                            </div>
                            <!-- Thanh tiến trình trạng thái đơn hàng -->
                            <div class="order-progress">
                                @{
                                    var trangThai = don.TrangThaiDonHang;
                                    var isCancelled = trangThai == "HuyDon";

                                    string[] steps = new[] { "ChoXacNhan", "DangXuLy", "DangGiao", "DaGiao" };

                                    foreach (var step in steps)
                                    {
                                        var isActive = steps.ToList().IndexOf(trangThai) >= steps.ToList().IndexOf(step);
                                        var isCancelledStep = isCancelled && step == trangThai;

                                        <div class="progress-step @(isCancelledStep ? "cancelled" : (isActive ? "active" : ""))">
                                            <div class="circle">@step.Substring(0, 2)</div>
                                            <span>@step</span>
                                        </div>
                                    }

                                    if (isCancelled && !steps.Contains(trangThai))
                                    {
                                        <div class="progress-step cancelled">
                                            <div class="circle">Hu</div>
                                            <span>HuyDon</span>
                                        </div>
                                    }
                                }
                            </div>

                            @{
                                var firstProduct = don.ChiTietDonHangs.FirstOrDefault();
                                var otherProducts = don.ChiTietDonHangs.Skip(1).ToList();
                            }

                            <!-- Sản phẩm đầu tiên -->
                            @if (firstProduct != null)
                            {
                                <div class="d-flex align-items-center border-top pt-3 mt-2">
                                    <img src="@firstProduct.SanPham.ImageURL" class="img-thumbnail me-3" style="width: 80px; height: 80px;" />
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">@firstProduct.SanPham.TenSP</div>
                                        <div class="text-muted">@firstProduct.SoLuong</div>
                                        <a asp-controller="SanPham" asp-action="Details" asp-route-id="@firstProduct.SanPham.MaSP"class="btn btn-sm btn-outline-primary mt-1"> Xem chi tiết</a>
                                    </div>
                                    <div class="text-end fw-semibold text-danger" style="white-space: nowrap;">
                                        @firstProduct.DonGia.ToString("N0") ₫
                                    </div>
                                </div>
                            }

                            <!-- Các sản phẩm khác (ẩn đi ban đầu) -->
                            @if (otherProducts.Count > 0)
                            {
                                var sectionId = $"orderItems_{don.MaDonHang}";
                                <div id="@sectionId" style="display:none;">
                                    @foreach (var ct in otherProducts)
                                    {
                                        <div class="d-flex align-items-center border-top pt-3 mt-2">
                                            <img src="@ct.SanPham.ImageURL" class="img-thumbnail me-3" style="width: 80px; height: 80px;" />
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold">@ct.SanPham.TenSP</div>
                                                <div class="text-muted">@ct.SoLuong</div>
                                                <a asp-controller="SanPham" asp-action="Details" asp-route-id="@ct.SanPham.MaSP"class="btn btn-sm btn-outline-primary mt-1"> Xem chi tiết</a>
                                            </div>
                                            <div class="text-end fw-semibold text-danger" style="white-space: nowrap;">
                                                @ct.DonGia.ToString("N0") ₫
                                            </div>
                                        </div>
                                    }
                                </div>
                                <!-- Nút xem thêm / ẩn bớt -->
                                <button class="btn btn-link px-0 text-decoration-none text-primary" type="button"
                                        onclick="toggleOrderItems('@sectionId', this)">
                                    + Xem thêm (@otherProducts.Count sản phẩm)
                                </button>
                            }


                            <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-3">
                                <div class="text-muted">Thanh toán: @don.TrangThaiThanhToan</div>
                                <div class="fw-bold">Tổng tiền: <span class="text-danger">@don.TongTien.ToString("N0") ₫</span></div>
                                @if (don.TrangThaiDonHang == "ChoXacNhan" || don.TrangThaiDonHang == "DangXuLy")
                {
                    <form asp-controller="DonHang" asp-action="HuyDon" method="post" onsubmit="return confirm('Bạn có chắc muốn hủy đơn hàng này không?');">
                        <input type="hidden" name="maDonHang" value="@don.MaDonHang" />
                        <button type="submit" class="btn btn-outline-danger mt-2">❌ Hủy đơn hàng</button>
                    </form>
                }

                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Bạn chưa có đơn hàng nào được ghi nhận.</p>
                }
            </div>

            <!-- Địa chỉ đặt hàng -->
            <div id="addressSection" class="content-section">
                <h4 class="mb-3 text-warning">📍 Địa chỉ đặt hàng</h4>

                @if (taiKhoan != null && taiKhoan.DiaChiNguoiDungs != null && taiKhoan.DiaChiNguoiDungs.Count > 0)
                {
                    foreach (var diaChi in taiKhoan.DiaChiNguoiDungs)
                    {
                       
                       <div class="border rounded p-3 mb-3 @(diaChi.MacDinh ? "border-success" : "")">
    <div><strong>Họ tên:</strong> @diaChi.TenNguoiNhan</div>
    <div><strong>Số điện thoại:</strong> @diaChi.SoDienThoai</div>
    <div><strong>Địa chỉ:</strong> @diaChi.DiaChiChiTiet</div>
    <div><strong>Phường/Xã:</strong> @diaChi.PhuongXa</div>
    <div><strong>Quận/Huyện:</strong> @diaChi.QuanHuyen</div>
    <div><strong>Tỉnh/TP:</strong> @diaChi.TinhTP</div>

    @if (diaChi.MacDinh)
    {
        <div class="badge bg-success mt-2">✅ Địa chỉ mặc định</div>
    }
    else
    {
        <div class="address-buttons mt-3">
            <form asp-controller="DiaChi" asp-action="SetDefault" method="post">
                <input type="hidden" name="id" value="@diaChi.MaDiaChi" />
                <button type="submit" class="address-btn blue">Chọn làm mặc định</button>
            </form>

            <form asp-controller="DiaChi" asp-action="Edit" method="get">
                <input type="hidden" name="id" value="@diaChi.MaDiaChi" />
                <button type="submit" class="address-btn orange">✏️ Sửa</button>
            </form>
        </div>
    }
</div>


                    }
                }
                else
                {
                    <p class="text-muted">Bạn chưa có địa chỉ nào.</p>
                }

                <button class="btn btn-outline-warning" type="button" onclick="toggleNewAddress()">➕ Thêm địa chỉ mới</button>
                <hr />

                <form id="newAddressForm" method="post" asp-action="ThemDiaChi" asp-controller="User" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-6">
                    <label class="form-label">Họ tên người nhận</label>
                    <input type="text" name="TenNguoiNhan" class="form-control" required />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Số điện thoại</label>
                    <input type="text" name="SoDienThoai" class="form-control" required />
                </div>

                    <div class="col-md-12">
                        <label class="form-label">Địa chỉ chi tiết</label>
                        <input type="text" name="DiaChiChiTiet" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Phường/Xã</label>
                        <input type="text" name="PhuongXa" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Quận/Huyện</label>
                        <input type="text" name="QuanHuyen" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tỉnh/Thành phố</label>
                        <input type="text" name="TinhTP" class="form-control" required />
                    </div>
                    <div class="col-md-12 form-check">
                        <input type="checkbox" class="form-check-input" name="MacDinh" id="macDinhCheckbox" />
                        <label class="form-check-label" for="macDinhCheckbox">Đặt làm địa chỉ mặc định</label>
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-success">📍 Lưu địa chỉ</button>
                    </div>
                </form>
            </div>

            <!-- ❤️ Sản phẩm yêu thích -->
<div id="favoritesSection" class="content-section">
    <h4 class="mb-3 fw-bold">❤️ Danh sách yêu thích</h4>

    @if (ViewBag.SanPhamYeuThich == null || !((List<SanPham>)ViewBag.SanPhamYeuThich).Any())
    {
        <div class="alert alert-info">Bạn chưa thêm sản phẩm nào vào danh sách yêu thích.</div>
    }
    else
    {
        var yeuThichList = (List<SanPham>)ViewBag.SanPhamYeuThich;
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            @foreach (var sp in yeuThichList)
            {
                <div class="col">
                    <div class="card h-100">
                        <img src="@sp.ImageURL" class="card-img-top" style="height: 180px; object-fit: cover;" />
                       <div class="card-body d-flex flex-column">
    <h6 class="fw-semibold">@sp.TenSP</h6>
    <p class="text-danger fw-semibold">@sp.DonGia.ToString("N0") đ</p>

    <div class="button-group">
        <a asp-controller="SanPham" asp-action="Details" asp-route-id="@sp.MaSP" class="custom-btn green">Xem chi tiết</a>

        <form asp-controller="YeuThich" asp-action="BoYeuThich" method="post" style="margin: 0;">
            <input type="hidden" name="maSP" value="@sp.MaSP" />
            <button type="submit" class="custom-btn red">💔 Bỏ yêu thích</button>
        </form>
    </div>
</div>

                    </div>
                </div>
            }
        </div>
    }
</div>
<!-- 🔐 Đổi mật khẩu -->
<div id="changePasswordSection" class="content-section" style="display: none;">
    <h4 class="mb-3 text-primary">Đổi mật khẩu</h4>

    <form asp-controller="User" asp-action="DoiMatKhau" method="post">
        <div class="form-group mb-2">
            <label for="OldPassword">Mật khẩu hiện tại</label>
            <input type="password" class="form-control" name="OldPassword" required />
        </div>
        <div class="form-group mb-2">
            <label for="NewPassword">Mật khẩu mới</label>
            <input type="password" class="form-control" name="NewPassword" required />
        </div>
        <div class="form-group mb-3">
            <label for="ConfirmPassword">Xác nhận mật khẩu mới</label>
            <input type="password" class="form-control" name="ConfirmPassword" required />
        </div>
        <button type="submit" class="btn btn-success">Đổi mật khẩu</button>
    </form>

    @if (TempData["PasswordChangeMessage"] != null)
    {
        <div class="alert alert-info mt-3">@TempData["PasswordChangeMessage"]</div>
    }
</div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function toggleOrderItems(sectionId, btn) {
        const section = document.getElementById(sectionId);
        const isHidden = getComputedStyle(section).display === "none";
        section.style.display = isHidden ? "block" : "none";
        btn.innerText = isHidden ? "Ẩn bớt" : "+ Xem thêm";
    }

    function toggleNewAddress() {
        const form = document.getElementById("newAddressForm");
        const isHidden = getComputedStyle(form).display === "none";
        form.style.display = isHidden ? "block" : "none";
    }
    function showSection(id, el) {
    document.querySelectorAll('.content-section').forEach(sec => sec.style.display = 'none');
    document.getElementById(id).style.display = 'block';

    document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
    el.classList.add('active');
}
 window.addEventListener("DOMContentLoaded", function () {
            const hash = window.location.hash;
            if (hash === "#historySection") {
                showSection("historySection", document.querySelector('li[onclick*="historySection"]'));
            }
        });
</script>
}

