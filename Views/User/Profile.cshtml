@using Final_Project.Models.Shop
@{
    ViewData["Title"] = "Thông tin tài khoản";
    var taiKhoan = ViewBag.TaiKhoan as Final_Project.Models.User.TaiKhoan;
    var donHangs = Model as List<DonHang>;
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<link rel="stylesheet" href="~/css/canhan.css">




<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <ul class="sidebar-menu">
                <li class="active" onclick="showSection('profileSection', this)">🧍 Thông tin cá nhân</li>
                <li onclick="showSection('historySection', this)">📜 Lịch sử mua hàng</li>
                <li onclick="showSection('addressSection', this)">📍 Địa chỉ đặt hàng</li>
                <li onclick="showSection('favoritesSection', this)">❤️ Sản phẩm yêu thích</li>
                <li onclick="showSection('changePasswordSection', this)">🔐 Đổi mật khẩu</li>
            </ul>
        </div>

        <div class="col-md-9">
            <div id="profileSection" class="content-section active">
                <h4 class="mb-3 text-success">👤 Thông tin tài khoản</h4>
                <div class="text-center mb-4">
    <img src="@(string.IsNullOrEmpty(taiKhoan?.Avatar) ? "imagesdefault-avatar.png" : taiKhoan.Avatar)"
         alt="Avatar"
         class="rounded-circle shadow"
         style="width: 120px; height: 120px; object-fit: cover;" />
</div>

<form asp-action="UploadAvatar" asp-controller="User" method="post" enctype="multipart/form-data" class="text-center mb-4">
    <input type="hidden" name="MaTK" value="@taiKhoan?.MaTK" />
    <input type="file" name="avatarFile" class="form-control w-50 d-inline-block mb-2" accept="image/*" required />
    <button type="submit" class="btn btn-outline-primary btn-sm">📤 Đổi ảnh đại diện</button>
</form>

                <div id="viewInfo">
                    <div class="border p-3 rounded shadow-sm mb-3">
                        <p><strong>Họ tên:</strong> @taiKhoan?.HoTen</p>
                        <p><strong>Email:</strong> @taiKhoan?.Email</p>
                        <p><strong>SĐT:</strong> @taiKhoan?.SDT</p>
                    </div>
                    <button class="btn btn-outline-success" onclick="toggleEdit(true)">✏️ Chỉnh sửa</button>
                </div>

                <div id="editInfo" style="display:none;">
                    <form method="post" asp-action="UpdateProfile" asp-controller="User">
                        <input type="hidden" name="MaTK" value="@taiKhoan?.MaTK" />
                        <div class="mb-3">
                            <label class="form-label">Họ tên</label>
                            <input type="text" name="HoTen" class="form-control" value="@taiKhoan?.HoTen" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="Email" class="form-control" value="@taiKhoan?.Email" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" name="SDT" class="form-control" value="@taiKhoan?.SDT" required />
                        </div>
                        <button type="submit" class="btn btn-success">💾 Lưu</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="toggleEdit(false)">❌ Hủy</button>
                    </form>
                </div>
            </div>


            <div id="historySection" class="content-section">
                <h4 class="mb-3 text-primary">🛒 Lịch sử mua hàng</h4>
                @if (donHangs != null && donHangs.Count > 0)
                {
                    foreach (var don in donHangs)
                    {
                        <div class="order-card shadow-sm rounded p-3 mb-4 border">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="fw-semibold">Đơn hàng #@don.MaDonHang</span> -
                                    <span class="text-muted">@don.NgayDat.ToString("dd/MM/yyyy")</span>
                                     <span class="text-muted">
    <strong>📍 Giao đến:</strong>
    @don.DiaChiNguoiDung.DiaChiChiTiet,
    @don.DiaChiNguoiDung.PhuongXa,
    @don.DiaChiNguoiDung.QuanHuyen,
    @don.DiaChiNguoiDung.TinhTP
</span>
                                </div>
                                <div class="text-success fw-bold">🟢 @don.TrangThaiDonHang</div>
                            </div>
                            <div class="order-progress">
                                @{
                                    var trangThai = don.TrangThaiDonHang;
                                    var isCancelled = trangThai == "HuyDon";

                                    string[] steps = new[] { "ChoXacNhan", "DangXuLy", "DangGiao", "DaGiao" };

                                    foreach (var step in steps)
                                    {
                                        var isActive = steps.ToList().IndexOf(trangThai) >= steps.ToList().IndexOf(step);
                                        var isCancelledStep = isCancelled && step == trangThai;

                                        <div class="progress-step @(isCancelledStep ? "cancelled" : (isActive ? "active" : ""))">
                                            <div class="circle">@step.Substring(0, 2)</div>
                                            <span>@step</span>
                                        </div>
                                    }

                                    if (isCancelled && !steps.Contains(trangThai))
                                    {
                                        <div class="progress-step cancelled">
                                            <div class="circle">Hu</div>
                                            <span>HuyDon</span>
                                        </div>
                                    }
                                }
                            </div>

                            @{
                                var firstProduct = don.ChiTietDonHangs.FirstOrDefault();
                                var otherProducts = don.ChiTietDonHangs.Skip(1).ToList();
                            }

                            @if (firstProduct != null)
                            {
                                <div class="d-flex align-items-center border-top pt-3 mt-2">
                                    <img src="@firstProduct.SanPham.ImageURL" class="img-thumbnail me-3" style="width: 80px; height: 80px;" />
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">@firstProduct.SanPham.TenSP</div>
                                        <div class="text-muted">@firstProduct.SoLuong</div>
                                        <a asp-controller="SanPham" asp-action="Details" asp-route-id="@firstProduct.SanPham.MaSP"class="btn btn-sm btn-outline-primary mt-1"> Xem chi tiết</a>
                                    </div>
                                    <div class="text-end fw-semibold text-danger" style="white-space: nowrap;">
                                        @firstProduct.DonGia.ToString("N0") ₫
                                    </div>
                                </div>
                            }

                            @if (otherProducts.Count > 0)
                            {
                                var sectionId = $"orderItems_{don.MaDonHang}";
                                <div id="@sectionId" style="display:none;">
                                    @foreach (var ct in otherProducts)
                                    {
                                        <div class="d-flex align-items-center border-top pt-3 mt-2">
                                            <img src="@ct.SanPham.ImageURL" class="img-thumbnail me-3" style="width: 80px; height: 80px;" />
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold">@ct.SanPham.TenSP</div>
                                                <div class="text-muted">@ct.SoLuong</div>
                                                <a asp-controller="SanPham" asp-action="Details" asp-route-id="@ct.SanPham.MaSP"class="btn btn-sm btn-outline-primary mt-1"> Xem chi tiết</a>
                                            </div>
                                            <div class="text-end fw-semibold text-danger" style="white-space: nowrap;">
                                                @ct.DonGia.ToString("N0") ₫
                                            </div>
                                        </div>
                                    }
                                </div>
                                <button class="btn btn-link px-0 text-decoration-none text-primary" type="button"
                                        onclick="toggleOrderItems('@sectionId', this)">
                                    + Xem thêm (@otherProducts.Count sản phẩm)
                                </button>
                            }


                            <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-3">
                                <div class="text-muted">Thanh toán: @don.TrangThaiThanhToan</div>
                                <div class="fw-bold">Tổng tiền: <span class="text-danger">@don.TongTien.ToString("N0") ₫</span></div>
                                @if (don.TrangThaiDonHang == "ChoXacNhan" || don.TrangThaiDonHang == "DangXuLy")
                {
                    <form asp-controller="DonHang" asp-action="HuyDon" method="post" onsubmit="return confirm('Bạn có chắc muốn hủy đơn hàng này không?');">
                        <input type="hidden" name="maDonHang" value="@don.MaDonHang" />
                        <button type="submit" class="btn btn-outline-danger mt-2">❌ Hủy đơn hàng</button>
                    </form>
                }

                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Bạn chưa có đơn hàng nào được ghi nhận.</p>
                }
            </div>

            <div id="addressSection" class="content-section">
                <h4 class="mb-3 text-warning">📍 Địa chỉ đặt hàng</h4>

                @if (taiKhoan != null && taiKhoan.DiaChiNguoiDungs != null && taiKhoan.DiaChiNguoiDungs.Count > 0)
                {
                    foreach (var diaChi in taiKhoan.DiaChiNguoiDungs)
                    {
                       
                        <div class="border rounded p-3 mb-3 @(diaChi.MacDinh ? "border-success" : "")">
    <div><strong>Họ tên:</strong> @diaChi.TenNguoiNhan</div>
    <div><strong>Số điện thoại:</strong> @diaChi.SoDienThoai</div>
    <div><strong>Địa chỉ:</strong> @diaChi.DiaChiChiTiet</div>
    <div><strong>Phường/Xã:</strong> @diaChi.PhuongXa</div>
    <div><strong>Quận/Huyện:</strong> @diaChi.QuanHuyen</div>
    <div><strong>Tỉnh/TP:</strong> @diaChi.TinhTP</div>

    @if (diaChi.MacDinh)
    {
        <div class="badge bg-success mt-2">✅ Địa chỉ mặc định</div>
    }
    else
    {
        <div class="address-buttons mt-3">
            <form asp-controller="DiaChi" asp-action="SetDefault" method="post">
                <input type="hidden" name="id" value="@diaChi.MaDiaChi" />
                <button type="submit" class="address-btn blue">Chọn làm mặc định</button>
            </form>

            <form asp-controller="DiaChi" asp-action="Edit" method="get">
                <input type="hidden" name="id" value="@diaChi.MaDiaChi" />
                <button type="submit" class="address-btn orange">✏️ Sửa</button>
            </form>
        </div>
    }
</div>


                    }
                }
                else
                {
                    <p class="text-muted">Bạn chưa có địa chỉ nào.</p>
                }

                <button class="btn btn-outline-warning" type="button" onclick="toggleNewAddress()">➕ Thêm địa chỉ mới</button>
                <hr />

                <form id="newAddressForm" method="post" asp-action="ThemDiaChi" asp-controller="User" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-6">
                        <label class="form-label">Họ tên người nhận</label>
                        <input type="text" name="TenNguoiNhan" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" name="SoDienThoai" class="form-control" required />
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Địa chỉ chi tiết</label>
                        <input type="text" name="DiaChiChiTiet" class="form-control" placeholder="Số nhà, tên đường..." required />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Tỉnh/Thành phố</label>
                        <select id="provinceDropdown" class="form-control" required>
                            <option value="">-- Chọn Tỉnh/Thành --</option>
                        </select>
                        <input type="hidden" name="TinhTP" id="provinceNameHidden" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Quận/Huyện</label>
                        <select id="districtDropdown" class="form-control" required>
                            <option value="">-- Chọn Quận/Huyện --</option>
                        </select>
                        <input type="hidden" name="QuanHuyen" id="districtNameHidden" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Phường/Xã</label>
                        <select id="wardDropdown" class="form-control" required>
                            <option value="">-- Chọn Phường/Xã --</option>
                        </select>
                        <input type="hidden" name="PhuongXa" id="wardNameHidden" />
                    </div>

                    <div class="col-md-12 form-check">
                        <input type="checkbox" class="form-check-input" name="MacDinh" id="macDinhCheckbox" />
                        <label class="form-check-label" for="macDinhCheckbox">Đặt làm địa chỉ mặc định</label>
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-success">📍 Lưu địa chỉ</button>
                    </div>
                </form>
                </div>

        <div id="favoritesSection" class="content-section">
    <h4 class="mb-3 fw-bold">❤️ Danh sách yêu thích</h4>

    @if (ViewBag.SanPhamYeuThich == null || !((List<SanPham>)ViewBag.SanPhamYeuThich).Any())
    {
        <div class="alert alert-info">Bạn chưa thêm sản phẩm nào vào danh sách yêu thích.</div>
    }
    else
    {
        var yeuThichList = (List<SanPham>)ViewBag.SanPhamYeuThich;
        <div class="row justify-content-center row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            @foreach (var sp in yeuThichList)
            {
                <div class="col-auto">
                    <div class="card h-100 product-card">
                        <div class="position-relative">
                            <img src="@sp.ImageURL" class="card-img-top" style="height: 180px; object-fit: cover;" />
                            <span class="favorite-icon">❤️</span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h6 class="fw-semibold">@sp.TenSP</h6>
                            <p class="product-price">@sp.DonGia.ToString("N0") đ</p>

                            <div class="button-group mt-auto">
                                <a asp-controller="SanPham" asp-action="Details" asp-route-id="@sp.MaSP" class="custom-btn green">Xem chi tiết</a>

                                <form asp-controller="YeuThich" asp-action="BoYeuThich" method="post" style="margin: 0;">
                                    <input type="hidden" name="maSP" value="@sp.MaSP" />
                                    <button type="submit" class="custom-btn red">💔 Bỏ yêu thích</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>



<div id="changePasswordSection" class="content-section" style="display: none;">
    <h4 class="mb-3 fw-bold text-orange">🔐 Đổi mật khẩu</h4>

    <form asp-controller="User" asp-action="DoiMatKhau" method="post" class="password-form">
        <div class="form-group mb-3">
            <label for="OldPassword">Mật khẩu hiện tại</label>
            <input type="password" class="form-control" name="OldPassword" placeholder="Nhập mật khẩu hiện tại" required />
        </div>
        <div class="form-group mb-3">
            <label for="NewPassword">Mật khẩu mới</label>
            <input type="password" class="form-control" name="NewPassword" placeholder="Nhập mật khẩu mới" required />
        </div>
        <div class="form-group mb-4">
            <label for="ConfirmPassword">Xác nhận mật khẩu mới</label>
            <input type="password" class="form-control" name="ConfirmPassword" placeholder="Xác nhận mật khẩu mới" required />
        </div>
        <button type="submit" class="custom-btn orange w-100">Đổi mật khẩu</button>
    </form>

    @if (TempData["PasswordChangeMessage"] != null)
    {
        <div class="alert alert-info mt-3">@TempData["PasswordChangeMessage"]</div>
    }
</div>
         @section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // === HÀM VỪA DI CHUYỂN TỪ TRÊN XUỐNG ===
        function toggleEdit(showEdit) {
            document.getElementById("viewInfo").style.display = showEdit ? "none" : "block";
            document.getElementById("editInfo").style.display = showEdit ? "block" : "none";
        }

        // === SCRIPT GỐC CỦA TRANG ===
        function toggleOrderItems(sectionId, btn) {
            const section = document.getElementById(sectionId);
            const isHidden = getComputedStyle(section).display === "none";
            section.style.display = isHidden ? "block" : "none";
            btn.innerText = isHidden ? "Ẩn bớt" : "+ Xem thêm";
        }

        function toggleNewAddress() {
            const form = document.getElementById("newAddressForm");
            const isHidden = getComputedStyle(form).display === "none";
            form.style.display = isHidden ? "block" : "none";
        }

        // Đây là hàm showSection DUY NHẤT VÀ CHÍNH XÁC
        function showSection(id, el) {
            document.querySelectorAll('.content-section').forEach(sec => sec.style.display = 'none');
            document.getElementById(id).style.display = 'block';

            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            if (el) { // Thêm kiểm tra el tồn tại
                 el.classList.add('active');
            }
        }

        window.addEventListener("DOMContentLoaded", function () {
            const hash = window.location.hash;

            if (hash === "#historySection") {
                showSection("historySection", document.querySelector('li[onclick*="historySection"]'));
            }
            else if (hash === "#favoritesSection") {
                showSection("favoritesSection", document.querySelector('li[onclick*="favoritesSection"]'));
            }
            else if (hash === "#addressSection") { // Thêm để xử lý khi F5
                showSection("addressSection", document.querySelector('li[onclick*="addressSection"]'));
            }
            else if (hash === "#changePasswordSection") { // Thêm để xử lý khi F5
                showSection("changePasswordSection", document.querySelector('li[onclick*="changePasswordSection"]'));
            }
            // Kích hoạt tab đầu tiên nếu không có hash
            else if (!hash) {
                 showSection("profileSection", document.querySelector('li[onclick*="profileSection"]'));
            }
        });

        // === SCRIPT MỚI TỪ API GHN (Đã tích hợp Select2) ===
        $(document).ready(function () {
            
            // THÊM MỚI: Cấu hình Select2 dùng theme Bootstrap 5
            $.fn.select2.defaults.set("theme", "bootstrap-5");

            // Hàm gọi API trung gian (trong DiaChiController)
            function callApi(url, targetDropdown) {
                return $.ajax({
                    url: url,
                    type: "GET",
                    success: function (response) {
                        if (response && response.data) {
                            // SỬA ĐỔI: Không clear dropdown ở đây, để hàm .done() tự xử lý
                            return response.data; 
                        } else {
                            console.error("Không nhận được dữ liệu từ API: ", response);
                            return null;
                        }
                    },
                    error: function (err) {
                        console.error("Lỗi khi gọi API trung gian!", err);
                        alert("Lỗi tải dữ liệu. Vui lòng kiểm tra Token trong DiaChiController và F12 Console.");
                    }
                });
            }

            // 1. Tải Tỉnh/Thành
            callApi("@Url.Action("GetProvinces", "DiaChi")", $("#provinceDropdown")).done(function(response) {
                // SỬA ĐỔI: Thêm clear dropdown ở đây
                $("#provinceDropdown").empty().append('<option value="">-- Chọn Tỉnh/Thành --</option>');
                if (response && response.data) {
                    $.each(response.data, function (i, province) {
                        $("#provinceDropdown").append($('<option>', {
                            value: province.ProvinceID,
                            text: province.ProvinceName
                        }));
                    });
                }
                // THÊM MỚI: Khởi tạo Select2 sau khi có dữ liệu
                $('#provinceDropdown').select2();
            });

            // THÊM MỚI: Khởi tạo Select2 cho 2 dropdown rỗng ban đầu
            $('#districtDropdown').select2();
            $('#wardDropdown').select2();


            // 2. Tải Quận/Huyện khi Tỉnh/Thành thay đổi
            $("#provinceDropdown").change(function () {
                var provinceId = $(this).val();
                var provinceName = $(this).find("option:selected").text();
                $("#provinceNameHidden").val(provinceName); 

                // SỬA ĐỔI: Hủy Select2 cũ trước khi làm rỗng
                $('#districtDropdown').select2('destroy').empty().append('<option value="">-- Chọn Quận/Huyện --</option>');
                $('#wardDropdown').select2('destroy').empty().append('<option value="">-- Chọn Phường/Xã --</option>');

                // THÊM MỚI: Khởi tạo lại Select2 rỗng
                $('#districtDropdown').select2();
                $('#wardDropdown').select2();

                $("#districtNameHidden").val("");
                $("#wardNameHidden").val("");

                if (provinceId) {
                    var url = "@Url.Action("GetDistricts", "DiaChi")" + "?provinceId=" + provinceId;
                    callApi(url, $("#districtDropdown")).done(function(response) {
                        // SỬA ĐỔI: Hủy Select2 cũ trước khi thêm data
                        $('#districtDropdown').select2('destroy').empty().append('<option value="">-- Chọn Quận/Huyện --</option>');
                        if (response && response.data) {
                            $.each(response.data, function (i, district) {
                                $("#districtDropdown").append($('<option>', {
                                    value: district.DistrictID,
                                    text: district.DistrictName
                                }));
                            });
                        }
                        // THÊM MỚI: Khởi tạo lại Select2 với data mới
                        $('#districtDropdown').select2();
                    });
                }
            });

            // 3. Tải Phường/Xã khi Quận/Huyện thay đổi
            $("#districtDropdown").change(function () {
                var districtId = $(this).val();
                var districtName = $(this).find("option:selected").text();
                $("#districtNameHidden").val(districtName); 

                // SỬA ĐỔI: Hủy Select2 cũ trước khi làm rỗng
                $('#wardDropdown').select2('destroy').empty().append('<option value="">-- Chọn Phường/Xã --</option>');
                // THÊM MỚI: Khởi tạo lại Select2 rỗng
                $('#wardDropdown').select2();
                
                $("#wardNameHidden").val("");

                if (districtId) {
                    var url = "@Url.Action("GetWards", "DiaChi")" + "?districtId=" + districtId;
                    callApi(url, $("#wardDropdown")).done(function(response) {
                        // SỬA ĐỔI: Hủy Select2 cũ trước khi thêm data
                        $('#wardDropdown').select2('destroy').empty().append('<option value="">-- Chọn Phường/Xã --</option>');
                        
                        if (response && response.data) {
                            var wardsData = response.data;
                            if (!Array.isArray(wardsData)) {
                                wardsData = [wardsData]; 
                            }
                            $.each(wardsData, function (i, ward) {
                                $("#wardDropdown").append($('<option>', {
                                    value: ward.WardCode, 
                                    text: ward.WardName
                                }));
                            });
                        }
                        // THÊM MỚI: Khởi tạo lại Select2 với data mới
                        $('#wardDropdown').select2();
                    });
                }
            });

            // 4. Cập nhật tên Phường/Xã khi chọn (Giữ nguyên)
            $("#wardDropdown").change(function () {
                var wardName = $(this).find("option:selected").text();
                $("#wardNameHidden").val(wardName);
            });
        });
    </script>
}