@model List<Final_Project.Models.Shop.GioHangViewModel>

@{
    ViewData["Title"] = "Trang đặt hàng";
    var diaChi = ViewBag.DiaChi as Final_Project.Models.User.DiaChiNguoiDung;
    var hoTen = ViewBag.HoTen as string;
    var soDienThoai = ViewBag.SoDienThoai as string;
    var tongTien = Model.Sum(m => m.ThanhTien);
    var phiVanChuyen = 17000;
    var tongThanhToan = tongTien + phiVanChuyen;
}

<!-- CSS -->
<style>
    .section-title {
        font-weight: bold;
        margin-top: 20px;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
    }
    .product-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
    }
    .order-summary {
        text-align: right;
    }
    .btn-place-order {
        background-color: #ee4d2d;
        color: white;
        border: none;
    }
    .address-box {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .address-box.default {
        border-color: #ee4d2d;
        background-color: #fff6f0;
    }
</style>

<body class="container py-4">

    <!-- Địa chỉ -->
    <h4 class="section-title">📍 Địa Chỉ Nhận Hàng</h4>
    <div id="default-address" class="mb-3">
        <p>
            <strong id="default-name">@diaChi?.TenNguoiNhan</strong>
            (<span id="default-phone">@diaChi?.SoDienThoai</span>)
        </p>
        <p id="default-full-address">
            @diaChi?.DiaChiChiTiet, @diaChi?.PhuongXa, @diaChi?.QuanHuyen, @diaChi?.TinhTP
        </p>
        <button class="btn btn-link" type="button" onclick="toggleAddressList()">Thay đổi</button>
    </div>

    <!-- Danh sách địa chỉ -->
    <div id="addressList" style="display: none;" class="mb-4">
        <div id="addresses">
            
        </div>

        <button class="btn btn-sm btn-outline-success mb-2" type="button" onclick="toggleAddForm()">➕ Thêm địa chỉ mới</button>

        <div id="addForm" style="display: none;">
            <div class="mb-2"><input type="text" class="form-control" id="newName" placeholder="Họ tên"></div>
            <div class="mb-2"><input type="text" class="form-control" id="newPhone" placeholder="Số điện thoại"></div>
            <div class="mb-2"><input type="text" class="form-control" id="newAddr" placeholder="Địa chỉ chi tiết"></div>
            <button class="btn btn-primary btn-sm" type="button" onclick="addAddress()">Lưu địa chỉ</button>
        </div>
    </div>

    <!-- Sản phẩm -->
    <h4 class="section-title">📦 Sản phẩm</h4>
    @foreach (var sp in Model)
    {
        <div class="row align-items-center border p-3 mb-2">
            <div class="col-md-1">
                <img src="@sp.ImageURL" alt="product" class="product-image" />
            </div>
            <div class="col-md-5">
                <p class="mb-0">@sp.TenSP</p>
                <small>Số lượng: @sp.SoLuong</small>
            </div>
            <div class="col-md-2 text-center">₫@sp.DonGia.ToString("n0")</div>
            <div class="col-md-2 text-center">x @sp.SoLuong</div>
            <div class="col-md-2 text-end">₫@sp.ThanhTien.ToString("n0")</div>
        </div>
    }

    <!-- Vận chuyển -->
    <h4 class="section-title">🚚 Phương thức vận chuyển</h4>
    <div class="border p-3 mb-3">
        <p><strong>Vận Chuyển Nhanh</strong> - ₫@phiVanChuyen.ToString("n0")</p>
        <small>Dự kiến nhận hàng từ 1 Tháng 8 - 5 Tháng 8</small>
    </div>

    <!-- Voucher -->
    <h4 class="section-title">🎁 Voucher & Shopee Xu</h4>
    <div class="d-flex justify-content-between mb-3">
        <p>Không sử dụng Xu</p>
        <button class="btn btn-sm btn-outline-primary">Chọn Voucher</button>
    </div>

   <!-- Thanh toán -->
<h4 class="section-title">💳 Phương thức thanh toán</h4>
<form method="post" action="/ThanhToan/ThanhToan" id="checkoutForm">
    @foreach (var sp in Model)
    {
        <input type="hidden" name="chonSP" value="@sp.MaSP" />
    }
    <input type="hidden" name="paymentMethod" id="paymentMethod" />

    <div class="d-flex gap-3 flex-wrap mb-3">
        <button type="button" class="btn btn-outline-secondary" id="btnCOD">Thanh toán khi nhận hàng</button>
    
        <button type="button" class="btn btn-outline-secondary" id="btnMomo">Ví MOMO</button>
        <button type="button" class="btn btn-outline-secondary" id="btnVnpay">Ví VNPAY</button>

    </div>
    <input type="hidden" name="paymentMethod" id="paymentMethod" />

    <p class="text-muted">Phí thu hộ: ₫0 VND</p>

    <!-- Tổng tiền -->
    <h4 class="section-title">🧾 Tổng thanh toán</h4>
    <div class="order-summary">
        <p>Tổng tiền hàng: ₫@tongTien.ToString("n0")</p>
        <p>Phí vận chuyển: ₫@phiVanChuyen.ToString("n0")</p>
        <h5><strong>Tổng thanh toán: ₫@tongThanhToan.ToString("n0")</strong></h5>
    </div>

    <div class="text-end mt-4">
        <button class="btn btn-place-order px-4 py-2" type="button" onclick="submitFinalOrder()">Đặt hàng</button>
    </div>
</form>
<script>
    let selectedMethod = "";

    document.getElementById("btnCOD").addEventListener("click", function () {
        selectedMethod = "COD";
        highlightSelected(this);
    });



    document.getElementById("btnMomo").addEventListener("click", function () {
        selectedMethod = "MOMO";
        highlightSelected(this);
    });

    document.getElementById("btnVnpay").addEventListener("click", function () {
    selectedMethod = "VNPAY";
    highlightSelected(this);
});


    function highlightSelected(button) {
    document.querySelectorAll("#btnCOD, #btnMomo, #btnVnpay").forEach(btn => {
        btn.classList.remove("btn-danger");
        btn.classList.add("btn-outline-secondary");
    });
    button.classList.remove("btn-outline-secondary");
    button.classList.add("btn-danger");
}

   function submitFinalOrder() {
    if (!selectedMethod) {
        alert("Vui lòng chọn phương thức thanh toán.");
        return;
    }

    if (selectedMethod === "MOMO") {
        let url = "/ThanhToan/TaoMomoQRCode?";
        document.querySelectorAll("input[name='chonSP']").forEach(sp => {
            url += "chonSP=" + sp.value + "&";
        });
        url += "tongTien=" + @tongThanhToan;
        window.location.href = url;
    } else if (selectedMethod === "VNPAY") {
        let url = "/ThanhToan/TaoVnpayQRCode?";
        document.querySelectorAll("input[name='chonSP']").forEach(sp => {
            url += "chonSP=" + sp.value + "&";
        });
        url += "tongTien=" + @tongThanhToan;
        window.location.href = url;
    } else {
        document.getElementById("paymentMethod").value = selectedMethod;
        document.getElementById("checkoutForm").submit();
    }
}

</script>


    <!-- Script quản lý địa chỉ -->
    <script>
        function toggleAddressList() {
            const addressList = document.getElementById('addressList');
            addressList.style.display = addressList.style.display === 'none' ? 'block' : 'none';

            if (addressList.style.display === 'block') {
                fetch('/ThanhToan/LayDanhSachDiaChi')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const container = document.getElementById('addresses');
                            container.innerHTML = ''; // Xóa cũ

                            data.data.forEach(d => {
                                const div = document.createElement('div');
                                div.className = 'border rounded p-2 mb-2';
                                div.innerHTML = `
                                    <p><strong>${d.tenNguoiNhan}</strong> (${d.soDienThoai})</p>
                                    <p>${d.diaChiChiTiet}, ${d.phuongXa}, ${d.quanHuyen}, ${d.tinhTP}</p>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="chonDiaChi(${d.maDC})">Chọn địa chỉ này</button>
                                `;
                                container.appendChild(div);
                            });
                        } else {
                            alert(data.message || 'Không thể tải địa chỉ.');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Có lỗi xảy ra khi tải địa chỉ.');
                    });
            }
        }

        function chonDiaChi(maDiaChi) {
            // Gửi request lên server để chọn địa chỉ, hoặc cập nhật UI tạm thời
            console.log("Địa chỉ được chọn:", maDiaChi);
            // Ví dụ: reload lại trang hoặc update div defaultAddress
            location.reload(); // Giải pháp tạm
        }
    </script>


</body>
