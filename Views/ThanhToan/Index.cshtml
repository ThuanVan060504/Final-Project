@model List<Final_Project.Models.Shop.GioHangViewModel>
@using Newtonsoft.Json
@{
    ViewData["Title"] = "Trang đặt hàng";
    var diaChi = ViewBag.DiaChi as Final_Project.Models.User.DiaChiNguoiDung;
    var hoTen = ViewBag.HoTen as string;
    var soDienThoai = ViewBag.SoDienThoai as string;
    var tongTien = Model.Sum(m => m.ThanhTien);

    // Xóa phí vận chuyển gán cứng. JS sẽ tính toán và cập nhật.
    var phiVanChuyen = 0;
    var tongThanhToan = tongTien + phiVanChuyen;

    // Lấy danh sách voucher từ ViewBag
    var myVouchers = ViewBag.MyVouchers as List<Final_Project.Models.Shop.Voucher> ?? new List<Final_Project.Models.Shop.Voucher>();
}


<style>
    /* =========================================== */
    /* == CSS MODAL ĐỊA CHỈ (Modal 1 & 2) == */
    /* =========================================== */
    #address-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); /* Nền mờ */
        z-index: 1040; /* Dưới modal thêm địa chỉ */
        display: none; /* Mặc định ẩn */
        justify-content: center;
        align-items: center;
        padding: 15px;
    }

    #addressList {
        max-width: 600px;
        width: 100%;
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .address-modal-close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        color: #555;
        opacity: 0.7;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
    }

        .address-modal-close-btn:hover {
            opacity: 1;
            color: #000;
        }

    #add-form-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1050; /* Trên modal chọn địa chỉ */
        display: none;
        justify-content: center;
        align-items: center;
        padding: 15px;
    }

    #addForm {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        width: 100%;
        max-width: 600px;
        display: block !important;
    }

    .btn-cancel-add {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        font-weight: 600;
        border-radius: 6px;
        padding: 6px 16px;
        transition: background-color 0.3s ease;
        margin-left: 10px;
    }

        .btn-cancel-add:hover {
            background-color: #5a6268;
        }

    /* =========================================== */
    /* == CSS CHUNG CỦA TRANG == */
    /* =========================================== */
    :root {
        --main-orange: #ff9e4f;
        --main-orange-dark: #e88738;
        --text-dark: #333;
        --text-light: #555;
        --bg-light: #fafafa;
    }

    .section-title {
        font-weight: 600;
        font-size: 25px;
        margin-top: 30px;
        margin-bottom: 15px;
        border-bottom: 2px solid #000;
        padding-bottom: 6px;
        color: var(--text-dark);
    }

    #default-address {
        background-color: var(--bg-light);
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px 20px;
        max-width: 500px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

        #default-address p {
            margin-bottom: 6px;
            font-size: 22px;
            color: var(--text-dark);
        }

        #default-address strong#default-name {
            font-size: 22px;
            font-weight: 600;
            color: var(--main-orange);
        }

    span#default-phone {
        font-size: 22px;
    }

    #default-address button {
        font-size: 20px;
        color: var(--main-orange);
        font-weight: 500;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        transition: color 0.2s ease;
    }

        #default-address button:hover {
            text-decoration: underline;
            color: var(--main-orange-dark);
        }

    #addressList #addresses div {
        background-color: #fffaf5;
        border: 1px solid #ffd8b2;
        border-radius: 6px;
        padding: 12px 15px;
        margin-bottom: 12px;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

        #addressList #addresses div:hover {
            background-color: #ffe7cc;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }

        #addressList #addresses div p {
            margin: 3px 0;
            font-size: 0.95rem;
            color: var(--text-dark);
        }

    #addressList button.btn-outline-secondary {
        border-color: var(--main-orange);
        color: var(--main-orange);
        font-weight: 500;
    }

        #addressList button.btn-outline-secondary:hover {
            background-color: var(--main-orange);
            color: #fff;
        }

    #addForm input,
    #addForm select {
        border-radius: 6px;
        border: 1px solid #ccc;
        padding: 8px 12px;
        font-size: 0.95rem;
        width: 100%;
        transition: border-color 0.3s ease;
    }

        #addForm input:focus,
        #addForm select:focus {
            border-color: var(--main-orange);
            outline: none;
            box-shadow: 0 0 5px rgba(255,158,79,0.5);
        }

    #addForm button.btn-primary {
        background-color: var(--main-orange);
        border-color: var(--main-orange);
        font-weight: 600;
        border-radius: 6px;
        padding: 6px 16px;
        transition: background-color 0.3s ease;
    }

        #addForm button.btn-primary:hover {
            background-color: var(--main-orange-dark);
        }

    .row.align-items-center.border {
        background-color: #fff;
        border-radius: 8px;
        padding: 12px 15px !important;
        border: 1px solid #eee;
        transition: box-shadow 0.3s ease;
        font-size: 25px;
    }

        .row.align-items-center.border:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

    .product-image {
        border-radius: 6px;
        border: 1px solid #ddd;
        width: 60px;
        height: 60px;
        object-fit: cover;
    }

    .col-md-5 p.mb-0 {
        font-weight: 600;
        font-size: 25px;
        color: var(--text-dark);
    }

    .col-md-5 small {
        color: var(--text-light);
        font-style: italic;
    }

    .col-md-2.text-center, .col-md-2.text-end {
        font-weight: 600;
        font-size: 20px;
        color: var(--main-orange);
    }

    .border.p-3.mb-3 {
        background-color: #fff;
        border-radius: 8px;
        border: 1px solid #eee;
        padding: 12px;
        font-size: 22px;
    }

        .border.p-3.mb-3 p strong {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 22px;
        }

        .border.p-3.mb-3 small {
            color: var(--text-light);
            font-style: italic;
        }

    .shipping-option-box {
        border: 2px solid #28a745;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8fdf8;
        display: flex;
        align-items: center;
        max-width: 600px;
    }

        .shipping-option-box p {
            font-size: 26px;
            margin-bottom: 0;
            line-height: 1.2;
        }

        .shipping-option-box small {
            font-size: 20px;
            font-style: italic;
            color: #555;
        }

        .shipping-option-box .shipping-icon {
            width: 65px;
            height: 65px;
            object-fit: contain;
            margin-right: 15px;
        }

    .d-flex.justify-content-between.mb-3 p {
        font-weight: 500;
        font-size: 22px;
        color: var(--text-dark);
    }

    .btn-outline-primary {
        border-color: var(--main-orange);
        color: var(--main-orange);
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-outline-primary:hover {
            background-color: var(--main-orange);
            color: #fff;
        }

    .d-flex.gap-3.flex-wrap.mb-3 button {
        min-width: 150px;
        font-weight: 600;
        border-radius: 8px;
        height: 40px;
        border: 1.5px solid var(--main-orange);
        background-color: #fff;
        color: var(--main-orange);
        transition: all 0.3s ease;
        margin-right: 20px;
        font-size: 20px;
    }

        .d-flex.gap-3.flex-wrap.mb-3 button:hover {
            background-color: var(--main-orange);
            color: #fff;
        }

    .btn-danger {
        background-color: var(--main-orange) !important;
        border-color: var(--main-orange) !important;
        color: white !important;
    }

        .btn-danger:hover {
            background-color: var(--main-orange-dark) !important;
        }

    button.btn.btn-place-order.px-4.py-2 {
        font-size: 30px;
    }

    button.btn.btn-sm.btn-outline-primary {
        font-size: 22px;
    }

    .order-summary p {
        font-size: 23px;
        margin: 6px 0;
        font-weight: 600;
        color: var(--text-dark);
    }

    .order-summary h5 {
        margin-top: 10px;
        color: var(--main-orange-dark);
    }

    strong {
        font-size: 25px;
    }

    .btn-place-order {
        font-size: 1.15rem;
        font-weight: 700;
        padding: 10px 30px;
        border-radius: 8px;
        background-color: var(--main-orange);
        border: none;
        margin: 10px;
        color: white;
        box-shadow: 0 3px 8px rgba(255,158,79,0.5);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }

        .btn-place-order:hover {
            background-color: var(--main-orange-dark);
            box-shadow: 0 4px 12px rgba(255,158,79,0.7);
        }

    /* =========================================== */
    /* == CSS MODAL VOUCHER (Modal 3) == */
    /* =========================================== */
    #voucher-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1060; /* Cao nhất */
        display: none;
        justify-content: center;
        align-items: center;
        padding: 15px;
    }

    #voucher-modal {
        max-width: 500px;
        width: 100%;
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    /* Nút đóng modal voucher */
    .voucher-modal-close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        color: #555;
        opacity: 0.7;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
    }

        .voucher-modal-close-btn:hover {
            opacity: 1;
            color: #000;
        }

    .voucher-select-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        background-color: #fff4eb;
        border: 2px dashed #ff9933;
    }

        .voucher-select-item .voucher-content {
            flex-grow: 1;
            margin-right: 15px;
        }

            .voucher-select-item .voucher-content p {
                margin: 0;
                line-height: 1.4;
            }

        .voucher-select-item .voucher-code {
            font-weight: 700;
            color: #d9534f;
        }

        .voucher-select-item .voucher-desc {
            font-size: 0.9em;
            color: #555;
        }
</style>

<h4 class="section-title">Địa Chỉ Nhận Hàng</h4>
<div id="default-address" class="mb-3"
     data-district-id="@(diaChi?.DistrictID ?? "0")"
     data-ward-code="@(diaChi?.WardCode ?? "")">
    @if (diaChi != null)
    {
        <p>
            <strong id="default-name">@diaChi.TenNguoiNhan</strong>
            (<span id="default-phone">@diaChi.SoDienThoai</span>)
        </p>
        <p id="default-full-address">
            @diaChi.DiaChiChiTiet, @diaChi.PhuongXa, @diaChi.QuanHuyen, @diaChi.TinhTP
        </p>
    }
    else
    {
        <p>
            <strong id="default-name">Chưa có địa chỉ</strong>
            (<span id="default-phone">---</span>)
        </p>
        <p id="default-full-address">
            Vui lòng thêm địa chỉ nhận hàng để tiếp tục.
        </p>
    }
    <button class="btn btn-link" type="button" onclick="toggleAddressList()">Thay đổi</button>
</div>


<div id="address-overlay">
    <div id="addressList" class="mb-4">
        <button type="button" class="address-modal-close-btn" onclick="toggleAddressList()">&times;</button>
        <h5 style="margin-bottom: 15px; font-weight: 600;">Chọn địa chỉ nhận hàng</h5>
        <div id="addresses">
        </div>
        <button class="btn btn-sm btn-outline-success mb-2" type="button" onclick="toggleAddForm()">➕ Thêm địa chỉ mới</button>
    </div>
</div>

<div id="add-form-overlay">
    <div id="addForm">
        <button type="button" class="address-modal-close-btn" onclick="toggleAddForm()">&times;</button>
        <h5 style="margin-bottom: 15px; font-weight: 600;">Thêm địa chỉ mới</h5>
        <div class="mb-2"><input type="text" class="form-control" id="newName" placeholder="Họ tên"></div>
        <div class="mb-2"><input type="text" class="form-control" id="newPhone" placeholder="Số điện thoại"></div>
        <div class="mb-2">
            <select id="ghnProvinceSelect" class="form-control">
                <option value="">Vui lòng chọn Tỉnh/Thành</option>
            </select>
        </div>
        <div class="mb-2">
            <select id="ghnDistrictSelect" class="form-control" disabled>
                <option value="">Vui lòng chọn Quận/Huyện</option>
            </select>
        </div>
        <div class="mb-2">
            <select id="ghnWardSelect" class="form-control" disabled>
                <option value="">Vui lòng chọn Phường/Xã</option>
            </select>
        </div>
        <div class="mb-2"><input type="text" class="form-control" id="newAddr" placeholder="Địa chỉ chi tiết (Số nhà, tên đường...)"></div>
        <div>
            <button class="btn btn-primary btn-sm" type="button" onclick="saveNewAddress()">Lưu địa chỉ</button>
            <button class="btn btn-cancel-add btn-sm" type="button" onclick="toggleAddForm()">Hủy</button>
        </div>
    </div>
</div>

<div id="voucher-overlay">
    <div id="voucher-modal">
        <button type="button" class="voucher-modal-close-btn" onclick="toggleVoucherModal()">&times;</button>
        <h5 style="margin-bottom: 15px; font-weight: 600;">Chọn Voucher</h5>
        <div id="voucher-list-container">
        </div>
    </div>
</div>

<h4 class="section-title">Sản phẩm</h4>
@foreach (var sp in Model)
{
    <div class="row align-items-center border p-3 mb-2">
        <div class="col-md-1">
            <img src="@sp.ImageURL" alt="product" class="product-image" />
        </div>
        <div class="col-md-5">
            <p class="mb-0">@sp.TenSP</p>
            <small>Số lượng: @sp.SoLuong</small>
        </div>
        <div class="col-md-2 text-center">₫@sp.DonGia.ToString("n0")</div>
        <div class="col-md-2 text-center">x @sp.SoLuong</div>
        <div class="col-md-2 text-end">₫@sp.ThanhTien.ToString("n0")</div>
    </div>
}

<h4 class="section-title">Phương thức vận chuyển</h4>
<div class="shipping-option-box">
    <img src="~/images/G3TD_Ship.png" alt="Vận chuyển G3TD" class="shipping-icon">
    <div>
        <p><strong>Vận Chuyển Nhanh</strong> - <span id="shipping-fee-display">Đang tính...</span></p>
        <small id="shipping-time-display">Dự kiến nhận hàng...</small>
    </div>
</div>


<h4 class="section-title">Voucher</h4>
<div class="d-flex justify-content-between mb-3 align-items-center">
    <p id="voucher-display-text" class="text-success" style="font-weight: 600; font-size: 22px;">Chưa áp dụng voucher</p>
    <button class="btn btn-sm btn-outline-primary" type="button" onclick="toggleVoucherModal()">Chọn Voucher</button>
</div>

<h4 class="section-title">Phương thức thanh toán</h4>
<form method="post" action="/ThanhToan/ThanhToan" id="checkoutForm">
    @foreach (var sp in Model)
    {
        <input type="hidden" name="chonSP" value="@sp.MaSP" />
    }

    <div class="d-flex gap-3 flex-wrap mb-3">
        <button type="button" class="btn btn-outline-secondary" id="btnCOD">Thanh toán khi nhận hàng</button>
        <button type="button" class="btn btn-outline-secondary" id="btnMomo">Ví MOMO</button>
        <button type="button" class="btn btn-outline-secondary" id="btnVnpay">Ví VNPAY</button>
        <button type="button" class="btn btn-outline-secondary" id="btnPaypal">Ví PAYPAL</button>
    </div>
    <input type="hidden" name="paymentMethod" id="paymentMethod" />

    <p class="text-muted">Phí thu hộ: ₫0 VND</p>

    <h4 class="section-title">Tổng thanh toán</h4>
    <div class="order-summary">
        <input type="hidden" id="hidden-base-total" value="@tongTien" />
        <input type="hidden" id="hidden-shipping-fee" value="0" />
        <input type="hidden" id="hidden-discount-amount" value="0" />
        <input type="hidden" id="hidden-voucher-id" value="0" />

        <p>Tổng tiền hàng: ₫@tongTien.ToString("n0")</p>
        <p>Phí vận chuyển: <span id="shipping-fee-text">Đang tính...</span></p>
        <p style="color: red; font-weight: 600; font-size: 23px;">Giảm giá (Voucher): <span id="discount-text">-₫0</span></p>
        <h5><strong>Tổng thanh toán: <span id="total-payment-text">Đang tính...</span></strong></h5>
    </div>

    <div class="text-end mt-4">
        <button class="btn btn-place-order px-4 py-2" type="button" onclick="submitFinalOrder()">Đặt hàng</button>
    </div>
</form>

<script>
    // =============================================
    // KHAI BÁO BIẾN TOÀN CỤC (Global)
    // =============================================

    // Biến cho phương thức thanh toán
    let selectedMethod = "";

    // Biến cho API GHN
    const GHN_TOKEN = "c8dd5606-b8d8-11f0-b040-4e257d8388b4";
    const GHN_SHOP_ID = 197908;
    const GHN_API_MASTER_DATA = "https://dev-online-gateway.ghn.vn/shiip/public-api/master-data";
    const GHN_API_SERVICE = "https://dev-online-gateway.ghn.vn/shiip/public-api/v2/shipping-order";
    const SHOP_DISTRICT_ID = 3695; // TODO: Thay bằng ID Quận của kho
    const SHOP_WARD_CODE = "90748";  // TODO: Thay bằng Mã Phường của kho
    const DEFAULT_WEIGHT_GRAMS = 1000;
    const DEFAULT_HEIGHT_CM = 15;
    const DEFAULT_LENGTH_CM = 20;
    const DEFAULT_WIDTH_CM = 20;

    // Biến cho Modal Địa chỉ
    let ghnProvincesLoaded = false;
    const ghnProvinceSelect = document.getElementById('ghnProvinceSelect');
    const ghnDistrictSelect = document.getElementById('ghnDistrictSelect');
    const ghnWardSelect = document.getElementById('ghnWardSelect');

    // Biến cho Modal Voucher (Lấy từ C#)
    const myVouchers = @Html.Raw(JsonConvert.SerializeObject(myVouchers));


    // =============================================
    // HÀM HELPER CHUNG
    // =============================================

    /**
     * Hàm alert tùy chỉnh
     */
    function showCustomAlert(message) {
        console.warn("ALERT:", message);
        alert(message);
    }

    /**
     * Hàm gọi API GHN (Chung)
     */
    async function ghnApiCall(endpoint, options = {}, apiBase = GHN_API_MASTER_DATA) {
        try {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Token': GHN_TOKEN,
                'ShopId': GHN_SHOP_ID
            };
            const config = {
                method: 'GET', ...options,
                headers: { ...defaultHeaders, ...(options.headers || {}) }
            };
            const response = await fetch(`${apiBase}${endpoint}`, config);
            if (!response.ok) {
                const errorData = await response.json();
                if (errorData && errorData.code_message_value) {
                    throw new Error(errorData.code_message_value);
                }
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            if (result.code !== 200) {
                throw new Error(result.message || 'Lỗi không xác định từ GHN');
            }
            return result.data;
        } catch (error) {
            console.error('Lỗi khi gọi API GHN:', error.message);
            showCustomAlert(`Lỗi API GHN: ${error.message}. Vui lòng kiểm tra lại Token/ShopID.`);
            return null;
        }
    }


    // =============================================
    // LOGIC TÍNH TOÁN & CẬP NHẬT UI
    // =============================================

    /**
     * [CORE] Tính toán lại tổng tiền cuối cùng
     */
    function recalculateTotal() {
        const baseTotal = parseInt(document.getElementById('hidden-base-total').value) || 0;
        const shippingFee = parseInt(document.getElementById('hidden-shipping-fee').value) || 0;
        const discount = parseInt(document.getElementById('hidden-discount-amount').value) || 0;

        let finalTotal = baseTotal + shippingFee - discount;
        if (finalTotal < 0) {
            finalTotal = 0; // Không cho phép tổng tiền âm
        }

        // Cập nhật UI tổng tiền cuối cùng
        document.getElementById('total-payment-text').textContent = `₫${finalTotal.toLocaleString('vi-VN')}`;
    }

    /**
     * Cập nhật UI phí vận chuyển (ĐƯỢC GỌI BỞI GHN)
     * ĐÃ SỬA LỖI: Hàm này phải gọi recalculateTotal()
     */
    function updateFeeUI(feeAmount, feeText) {
        const shippingFee = parseInt(feeAmount) || 0;

        // Cập nhật các trường ẩn
        document.getElementById('hidden-shipping-fee').value = shippingFee;

        // Cập nhật văn bản
        document.getElementById('shipping-fee-display').textContent = feeText;
        document.getElementById('shipping-fee-text').textContent = feeText;

        // GỌI HÀM TÍNH TỔNG ĐỂ CẬP NHẬT LẠI
        recalculateTotal();
    }

    /**
     * Cập nhật UI thời gian giao hàng (ĐƯỢC GỌI BỞI GHN)
     */
    function updateEstimatedTime(deliveryDate) {
        const timeDisplay = document.getElementById('shipping-time-display');
        if (deliveryDate) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const formattedDate = deliveryDate.toLocaleDateString('vi-VN', options);
            timeDisplay.textContent = `Dự kiến nhận hàng vào ${formattedDate}`;
        } else {
            timeDisplay.textContent = 'Dự kiến nhận hàng...';
        }
    }


    // =============================================
    // LOGIC VẬN CHUYỂN (GHN)
    // =============================================

    /**
     * [CORE] Tính phí vận chuyển (Gọi API GHN)
     */
    async function updateShippingFee(toDistrictId, toWardCode) {
        const toDistrictIdNum = parseInt(toDistrictId);

        if (!toDistrictIdNum || !toWardCode || toDistrictIdNum === 0 || toWardCode === "") {
            console.warn("Thiếu DistrictID hoặc WardCode, không thể tính phí vận chuyển.");
            updateFeeUI(0, "Vui lòng chọn địa chỉ hợp lệ");
            updateEstimatedTime(null);
            return;
        }

        if (SHOP_DISTRICT_ID === 0 || SHOP_WARD_CODE === "") {
            console.error("CHƯA CẤU HÌNH SHOP_DISTRICT_ID và SHOP_WARD_CODE trong file JS.");
            showCustomAlert("Lỗi cấu hình: Thông tin kho hàng chưa được thiết lập.");
            updateFeeUI(0, "Lỗi cấu hình");
            updateEstimatedTime(null);
            return;
        }

        updateFeeUI(0, "Đang tính...");
        updateEstimatedTime(null);

        // 1. Lấy loại dịch vụ
        const servicePayload = {
            "from_district": SHOP_DISTRICT_ID,
            "to_district": toDistrictIdNum,
            "shop_id": GHN_SHOP_ID
        };
        const services = await ghnApiCall('/available-services', { method: 'POST', body: JSON.stringify(servicePayload) }, GHN_API_SERVICE);

        if (!services || services.length === 0) {
            updateFeeUI(0, "Không hỗ trợ vận chuyển");
            updateEstimatedTime(null);
            return;
        }

        let service = services.find(s => s.service_type_id === 2); // 2 = Chuẩn
        if (!service) service = services[0];
        const service_type_id = service.service_type_id;

        // 2. Lấy phí
        const feePayload = {
            "service_type_id": service_type_id,
            "shop_id": GHN_SHOP_ID,
            "from_district_id": SHOP_DISTRICT_ID,
            "from_ward_code": SHOP_WARD_CODE,
            "to_district_id": toDistrictIdNum,
            "to_ward_code": toWardCode,
            "height": DEFAULT_HEIGHT_CM, "length": DEFAULT_LENGTH_CM, "width": DEFAULT_WIDTH_CM, "weight": DEFAULT_WEIGHT_GRAMS,
            "insurance_value": parseInt(document.getElementById('hidden-base-total').value),
            "coupon": null
        };
        const feeData = await ghnApiCall('/fee', { method: 'POST', body: JSON.stringify(feePayload) }, GHN_API_SERVICE);

        if (feeData && feeData.total) {
            updateFeeUI(feeData.total, `₫${feeData.total.toLocaleString('vi-VN')}`);
        } else {
            updateFeeUI(0, "Không thể tính phí");
        }

        // 3. Lấy thời gian
        const timePayload = { ...feePayload };
        delete timePayload.insurance_value;
        delete timePayload.coupon;
        const timeData = await ghnApiCall('/leadtime', { method: 'POST', body: JSON.stringify(timePayload) }, GHN_API_SERVICE);

        if (timeData && timeData.leadtime) {
            const deliveryDate = new Date(timeData.leadtime * 1000);
            updateEstimatedTime(deliveryDate);
        } else {
            updateEstimatedTime(null);
        }
    }


    // =============================================
    // LOGIC MODAL ĐỊA CHỈ (Modal 1 & 2)
    // =============================================

    /**
     * Tải lại danh sách địa chỉ (Modal 1)
     */
    function refreshAddressList() {
        fetch('/ThanhToan/LayDanhSachDiaChi')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('addresses');
                    container.innerHTML = '';
                    data.data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'border rounded p-2 mb-2';
                        div.innerHTML =
                            `<p><strong>${d.tenNguoiNhan}</strong> (${d.soDienThoai})</p>
                             <p>${d.diaChiChiTiet}, ${d.phuongXa}, ${d.quanHuyen}, ${d.tinhTP}</p>
                             <button class="btn btn-sm btn-outline-secondary" onclick="chonDiaChi(${d.maDiaChi})">Chọn địa chỉ này</button>`;
                        container.appendChild(div);
                    });
                } else {
                    showCustomAlert(data.message || 'Không thể tải địa chỉ.');
                }
            })
            .catch(err => {
                console.error(err);
                showCustomAlert('Có lỗi xảy ra khi tải địa chỉ.');
            });
    }

    /**
     * Bật/tắt Modal 1 (Chọn địa chỉ)
     */
    function toggleAddressList() {
        const overlay = document.getElementById('address-overlay');
        const isHidden = overlay.style.display === 'none' || overlay.style.display === '';
        overlay.style.display = isHidden ? 'flex' : 'none';
        if (isHidden) {
            refreshAddressList();
        }
    }
    document.getElementById('address-overlay').addEventListener('click', function(e) {
        if (e.target.id === 'address-overlay') toggleAddressList();
    });

    /**
     * Xử lý khi bấm "Chọn địa chỉ này"
     */
    function chonDiaChi(maDiaChi) {
        console.log("Đang đổi địa chỉ mặc định thành:", maDiaChi);
        location.href = `/ThanhToan/ChonDiaChi?maDiaChi=${maDiaChi}`;
    }

    /**
     * Bật/tắt Modal 2 (Thêm địa chỉ)
     */
    function toggleAddForm() {
        const overlay = document.getElementById('add-form-overlay');
        const isHidden = overlay.style.display === 'none' || overlay.style.display === '';
        overlay.style.display = isHidden ? 'flex' : 'none';
        if (isHidden && !ghnProvincesLoaded) {
            initGHNAddressForm();
            ghnProvincesLoaded = true;
        }
    }
    document.getElementById('add-form-overlay').addEventListener('click', function(e) {
        if (e.target.id === 'add-form-overlay') toggleAddForm();
    });

    /**
     * Khởi chạy form GHN (Modal 2)
     */
    async function initGHNAddressForm() {
        const provinces = await ghnApiCall('/province');
        if (provinces) {
            ghnProvinceSelect.innerHTML = '<option value="">--- Chọn Tỉnh/Thành ---</option>';
            provinces.sort((a, b) => a.ProvinceName.localeCompare(b.ProvinceName));
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province.ProvinceID;
                option.textContent = province.ProvinceName;
                ghnProvinceSelect.appendChild(option);
            });
        }
    }
    ghnProvinceSelect.addEventListener('change', async (e) => {
        const provinceId = e.target.value;
        ghnDistrictSelect.innerHTML = '<option value="">Đang tải...</option>';
        ghnWardSelect.innerHTML = '<option value="">Vui lòng chọn Quận/Huyện</option>';
        ghnDistrictSelect.disabled = true; ghnWardSelect.disabled = true;
        if (!provinceId) return;
        const districts = await ghnApiCall(`/district?province_id=${provinceId}`);
        if (districts) {
            ghnDistrictSelect.innerHTML = '<option value="">--- Chọn Quận/Huyện ---</option>';
            districts.sort((a, b) => a.DistrictName.localeCompare(b.DistrictName));
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.DistrictID;
                option.textContent = district.DistrictName;
                ghnDistrictSelect.appendChild(option);
            });
            ghnDistrictSelect.disabled = false;
        }
    });
    ghnDistrictSelect.addEventListener('change', async (e) => {
        const districtId = e.target.value;
        ghnWardSelect.innerHTML = '<option value="">Đang tải...</option>';
        ghnWardSelect.disabled = true;
        if (!districtId) return;
        const wards = await ghnApiCall(`/ward?district_id=${districtId}`);
        if (wards) {
            ghnWardSelect.innerHTML = '<option value="">--- Chọn Phường/Xã ---</option>';
            wards.sort((a, b) => a.WardName.localeCompare(b.WardName));
            wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.WardCode;
                option.textContent = ward.WardName;
                ghnWardSelect.appendChild(option);
            });
            ghnWardSelect.disabled = false;
        }
    });

    /**
     * Lưu địa chỉ mới (Modal 2)
     */
    async function saveNewAddress() {
        const tenNguoiNhan = document.getElementById('newName').value.trim();
        const soDienThoai = document.getElementById('newPhone').value.trim();
        const diaChiChiTiet = document.getElementById('newAddr').value.trim();
        const provinceID = ghnProvinceSelect.value;
        const provinceName = ghnProvinceSelect.options[ghnProvinceSelect.selectedIndex].text;
        const districtID = ghnDistrictSelect.value;
        const districtName = ghnDistrictSelect.options[ghnDistrictSelect.selectedIndex].text;
        const wardCode = ghnWardSelect.value;
        const wardName = ghnWardSelect.options[ghnWardSelect.selectedIndex].text;

        if (!tenNguoiNhan || !soDienThoai || !diaChiChiTiet || !provinceID || !districtID || !wardCode) {
            showCustomAlert("Vui lòng điền đầy đủ thông tin địa chỉ.");
            return;
        }
        const data = {
            TenNguoiNhan: tenNguoiNhan, SoDienThoai: soDienThoai, DiaChiChiTiet: diaChiChiTiet,
            ProvinceID: parseInt(provinceID), ProvinceName: provinceName,
            DistrictID: parseInt(districtID), DistrictName: districtName,
            WardCode: wardCode, WardName: wardName
        };
        try {
            const response = await fetch('/ThanhToan/ThemDiaChiMoi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showCustomAlert("Thêm địa chỉ mới thành công!");
                toggleAddForm(); // Đóng modal 2
                refreshAddressList(); // Tải lại modal 1
            } else {
                showCustomAlert(result.message || "Lưu địa chỉ thất bại.");
            }
        } catch (error) {
            console.error("Lỗi khi lưu địa chỉ:", error);
            showCustomAlert("Lỗi kết nối khi lưu địa chỉ.");
        }
    }

    // =============================================
    // LOGIC MODAL VOUCHER (Modal 3)
    // =============================================

    /**
     * Bật/tắt Modal 3 (Chọn Voucher)
     */
    function toggleVoucherModal() {
        const overlay = document.getElementById('voucher-overlay');
        const isHidden = overlay.style.display === 'none' || overlay.style.display === '';
        overlay.style.display = isHidden ? 'flex' : 'none';
        if (isHidden) {
            loadVoucherList();
        }
    }
    document.getElementById('voucher-overlay').addEventListener('click', function (e) {
        if (e.target.id === 'voucher-overlay') toggleVoucherModal();
    });

    /**
     * Tải danh sách voucher vào Modal 3
     */
    function loadVoucherList() {
        const container = document.getElementById('voucher-list-container');
        container.innerHTML = '';
        const cartTotal = parseInt(document.getElementById('hidden-base-total').value) || 0;

        if (!myVouchers || myVouchers.length === 0) {
            container.innerHTML = '<p class="text-muted">Bạn không có voucher nào khả dụng.</p>';
            return;
        }

        let eligibleVouchers = 0;
        myVouchers.forEach(v => {
            const isEligible = cartTotal >= v.DonHangToiThieu;
            const buttonHtml = isEligible
                ? `<button class="btn btn-danger btn-sm" onclick="applyVoucher(${v.MaVoucherID})">Áp dụng</button>`
                : `<button class="btn btn-secondary btn-sm" disabled title="Cần đơn hàng tối thiểu ${v.DonHangToiThieu.toLocaleString('vi-VN')} đ">Không đủ ĐK</button>`;

            if (isEligible) eligibleVouchers++;

            const div = document.createElement('div');
            div.className = 'voucher-select-item';
            div.innerHTML = `
                <div class="voucher-content">
                    <p class="voucher-code">${v.MaCode}</p>
                    <p class="voucher-desc">${v.MoTa}</p>
                    <p class="voucher-desc">HSD: ${new Date(v.NgayKetThuc).toLocaleDateString('vi-VN')}</p>
                </div>
                <div class="voucher-action">
                    ${buttonHtml}
                </div>
            `;
            container.appendChild(div);
        });

        if (eligibleVouchers === 0 && myVouchers.length > 0) {
            container.insertAdjacentHTML('afterbegin', '<p class="text-danger">Không có voucher nào đủ điều kiện cho đơn hàng này.</p>');
        }
    }

    /**
     * [CORE] Xử lý khi bấm "Áp dụng" voucher
     */
    async function applyVoucher(voucherId) {
        const cartTotal = parseInt(document.getElementById('hidden-base-total').value) || 0;
        try {
            const formData = new FormData();
            formData.append('voucherId', voucherId);
            formData.append('cartTotal', cartTotal);

            const response = await fetch('/ThanhToan/ApDungVoucher', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showCustomAlert(result.message);

                // Lưu thông tin giảm giá
                document.getElementById('hidden-discount-amount').value = result.discountAmount;
                document.getElementById('hidden-voucher-id').value = result.maVoucherID;

                // Cập nhật UI
                document.getElementById('voucher-display-text').textContent = `Đang áp dụng: ${result.maCode}`;
                document.getElementById('discount-text').textContent = `-₫${result.discountAmount.toLocaleString('vi-VN')}`;

                recalculateTotal(); // Tính lại tổng tiền
                toggleVoucherModal(); // Đóng modal
            } else {
                showCustomAlert(result.message || "Áp dụng voucher thất bại.");
            }
        } catch (error) {
            console.error("Lỗi khi áp dụng voucher:", error);
            showCustomAlert("Lỗi kết nối khi áp dụng voucher.");
        }
    }

    // =============================================
    // LOGIC THANH TOÁN (Payment)
    // =============================================

    // Gắn sự kiện cho các nút thanh toán
    document.getElementById("btnCOD").addEventListener("click", function () {
        selectedMethod = "COD";
        highlightSelected(this);
    });
    document.getElementById("btnMomo").addEventListener("click", function () {
        selectedMethod = "MOMO";
        highlightSelected(this);
    });
    document.getElementById("btnVnpay").addEventListener("click", function () {
        selectedMethod = "VNPAY";
        highlightSelected(this);
    });
    document.getElementById("btnPaypal").addEventListener("click", function () {
        selectedMethod = "PAYPAL";
        highlightSelected(this);
    });

    /**
     * Làm nổi bật nút thanh toán được chọn
     */
    function highlightSelected(button) {
        document.querySelectorAll("#btnCOD, #btnMomo, #btnVnpay, #btnPaypal").forEach(btn => {
            btn.classList.remove("btn-danger");
            btn.classList.add("btn-outline-secondary");
        });
        button.classList.remove("btn-outline-secondary");
        button.classList.add("btn-danger");
    }

    /**
     * [CORE] Xử lý khi bấm "Đặt Hàng"
     */
    function submitFinalOrder() {
        if (!selectedMethod) {
            showCustomAlert("Vui lòng chọn phương thức thanh toán.");
            return;
        }

        const baseTotal = parseInt(document.getElementById('hidden-base-total').value) || 0;
        const shippingFee = parseInt(document.getElementById('hidden-shipping-fee').value) || 0;
        const discount = parseInt(document.getElementById('hidden-discount-amount').value) || 0;
        const voucherId = parseInt(document.getElementById('hidden-voucher-id').value) || 0;
        let finalTotal = baseTotal + shippingFee - discount;
        if (finalTotal < 0) finalTotal = 0;

        if (shippingFee === 0) {
            showCustomAlert("Chưa tính được phí vận chuyển. Vui lòng kiểm tra lại địa chỉ.");
            return;
        }

        // Vẫn cho phép thanh toán 0 đồng (nếu voucher giảm 100%)
        if (finalTotal < 0) {
            showCustomAlert("Tổng tiền không hợp lệ. Vui lòng tải lại trang.");
            return;
        }

        let url = "";
        const productInputs = document.querySelectorAll("input[name='chonSP']");
        let productQuery = "";
        productInputs.forEach(sp => {
            productQuery += "chonSP=" + sp.value + "&";
        });

        // Gửi tất cả thông tin lên
        productQuery += `shippingFee=${shippingFee}&`;
        productQuery += `discountAmount=${discount}&`;
        productQuery += `maVoucherID=${voucherId}&`;
        productQuery += `tongTien=${finalTotal}`; // tongTien là tổng cuối cùng

        if (selectedMethod === "MOMO" || selectedMethod === "VNPAY" || selectedMethod === "PAYPAL") {
            let action = "";
            if (selectedMethod === "MOMO") action = "TaoMomoQRCode";
            if (selectedMethod === "VNPAY") action = "TaoVnpayQRCode";
            if (selectedMethod === "PAYPAL") action = "TaoPaypalPayment";

            url = `/ThanhToan/${action}?${productQuery}`;
            window.location.href = url;
        }
        else {
            // Xử lý cho COD
            document.getElementById("paymentMethod").value = selectedMethod;
            const form = document.getElementById('checkoutForm');

            // Thêm các input ẩn vào form COD
            const shippingInput = document.createElement('input');
            shippingInput.type = 'hidden'; shippingInput.name = 'shippingFee'; shippingInput.value = shippingFee;
            form.appendChild(shippingInput);

            const discountInput = document.createElement('input');
            discountInput.type = 'hidden'; discountInput.name = 'discountAmount'; discountInput.value = discount;
            form.appendChild(discountInput);

            const voucherInput = document.createElement('input');
            voucherInput.type = 'hidden'; voucherInput.name = 'maVoucherID'; voucherInput.value = voucherId;
            form.appendChild(voucherInput);

            form.submit();
        }
    }

    // =============================================
    // KHỞI CHẠY KHI TẢI TRANG
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Lấy thông tin địa chỉ mặc định
        const defaultAddressDiv = document.getElementById('default-address');
        const districtId = defaultAddressDiv.getAttribute('data-district-id');
        const wardCode = defaultAddressDiv.getAttribute('data-ward-code');

        console.log("Địa chỉ mặc định:", { districtId, wardCode });

        // 2. Bắt đầu tính phí vận chuyển
        updateShippingFee(districtId, wardCode);

        // 3. Tính tổng tiền lần đầu (chưa có ship và voucher)
        recalculateTotal();
    });

</script>