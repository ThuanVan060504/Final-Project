@using Final_Project.Models.Shop
@using Final_Project.Models.ViewModels
@* Đảm bảo bạn đã khai báo namespace chứa class SlugHelper, ví dụ: *@
@* @using Final_Project.Utilities *@

@model List<SanPham>
@{
    ViewData["Title"] = "Sản phẩm";

    var activeFlashSales = (ViewBag.ActiveFlashSales as Dictionary<int, ChiTietFlashSale>)
                            ?? new Dictionary<int, ChiTietFlashSale>();
}

<link rel="stylesheet" href="~/css/sanpham.css">
<div class="container mt-5">
    <h2 class="fw-bold mb-4 text-center">Tất cả sản phẩm</h2>
    @if (ViewBag.Keyword != null)
    {
        <h4>Kết quả tìm kiếm cho: "<span class="text-danger">@ViewBag.Keyword</span>"</h4>

        @if (!Model.Any())
        {
            <div class="alert alert-warning text-center">
                Không tìm thấy sản phẩm nào phù hợp với từ khóa "<strong>@ViewBag.Keyword</strong>"
            </div>
        }
    }

    <div class="row">
        <div class="col-md-3 mb-4">
            <form method="get" asp-action="Index" class="card shadow-sm p-3">
                <h5 class="fw-semibold mb-3">Bộ lọc</h5>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Danh mục</label>
                    <select class="form-select" name="category">
                        <option value="">Tất cả</option>
                        <option value="Bàn làm việc">Bàn làm việc</option>
                        <option value="Ghế văn phòng">Ghế văn phòng</option>
                        <option value="Tủ kệ trang trí">Tủ kệ trang trí</option>
                        <option value="Phòng khách">Phòng khách</option>
                        <option value="Phòng ngủ">Phòng ngủ</option>
                        <option value="Phòng ăn">Phòng ăn</option>
                        <option value="Phòng làm việc">Phòng làm việc</option>
                        <option value="Nội thất trẻ em">Nội thất trẻ em</option>
                        <option value="Đồ trang trí">Đồ trang trí</option>
                        <option value="Đèn & chiếu sáng">Đèn & chiếu sáng</option>
                        <option value="Rèm, thảm & phụ kiện">Rèm, thảm & phụ kiện</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Tìm kiếm</label>
                    <input class="form-control" type="text" name="search" placeholder="Tên sản phẩm..."
                           value="@Context.Request.Query["search"]" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Sắp xếp theo</label>
                    <select class="form-select" name="sort">
                        <option value="">Mặc định</option>
                        <option value="asc">Giá tăng dần</option>
                        <option value="desc">Giá giảm dần</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100">Lọc sản phẩm</button>
            </form>
        </div>

        <div class="col-md-9">
            @if (!Model.Any())
            {
                <div class="alert alert-warning text-center">
                    Xin lỗi, chúng tôi hiện không có sản phẩm bạn yêu cầu.
                </div>
            }
            else
            {
                <div class="row g-4">
                    @foreach (var sp in Model)
                    {
                        var flashSale = activeFlashSales.GetValueOrDefault(sp.MaSP);

                        // --- 1. TẠO SLUG TẠI ĐÂY ---
                        // Giả sử class SlugHelper nằm trong namespace mặc định hoặc đã được using
                        string slug = SlugHelper.GenerateSlug(sp.TenSP);
                        // ---------------------------

                        <div class="col-md-4 col-sm-6 col-12">
                            <div class="card card-hover h-100 position-relative p-2 shadow-sm">

                                <form asp-controller="YeuThich" asp-action="Them" method="post"
                                      class="yeu-thich-form" onsubmit="themYeuThich(event)">
                                    <input type="hidden" name="maSP" value="@sp.MaSP" />
                                    <button type="submit" class="nut-yeu-thich" title="Thêm vào yêu thích">❤️</button>
                                </form>
                                <div id="thongBaoYeuThich" class="thong-bao-thanh-cong">Đã thêm vào yêu thích! ❤️</div>


                                @if (flashSale != null)
                                {
                                    <div class="discount-badge"
                                         style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: #ff424e; color: white; font-size: 14px; font-weight: bold; padding: 4px 8px; border-radius: 4px; z-index: 10;">
                                        -@flashSale.PhanTramGiam%
                                    </div>
                                }

                                @* --- 2. THAY THẾ LINK CŨ BẰNG LINK SEO FRIENDLY --- *@
                                <a href="/san-pham/@slug-@sp.MaSP" class="text-decoration-none text-dark">
                                    <img src="@sp.ImageURL" class="card-img-top" alt="@sp.TenSP" />
                                    <div class="card-body">
                                        <h6 class="fw-bold">@sp.TenSP</h6>

                                        @if (flashSale != null)
                                        {
                                            <p class="text-danger fw-semibold" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0;">@flashSale.GiaSauGiam.ToString("N0") đ</p>
                                            <p style="font-size: 1.0rem; text-decoration: line-through; color: #888; margin-top: -5px;">@sp.DonGia.ToString("N0") đ</p>
                                        }
                                        else
                                        {
                                            <p class="text-danger fw-semibold" style="font-size: 1.5rem; font-weight: 700;">@sp.DonGia.ToString("N0") đ</p>
                                        }
                                        <p class="text-muted small">@sp.MoTa</p>
                                        @{
                                            var soLuongDaBan = ViewBag.SoLuongDaBan.ContainsKey(sp.MaSP) ? ViewBag.SoLuongDaBan[sp.MaSP] : 0;
                                        }
                                        <p class="text-muted small">Đã bán: @soLuongDaBan sản phẩm</p>
                                        <p class="text-muted small">Còn lại: @sp.SoLuong sản phẩm</p>
                                    </div>
                                </a>
                                @* -------------------------------------------------- *@
                            </div>
                        </div>
                    }

                    @if (ViewBag.TotalPages > 1)
                    {
                        var currentPage = (int)ViewBag.CurrentPage;
                        var totalPages = (int)ViewBag.TotalPages;
                        var startPage = Math.Max(1, currentPage - 2);
                        var endPage = Math.Min(totalPages, currentPage + 2);

                        <nav class="mt-4 d-flex justify-content-center">
                            <ul class="pagination">

                                @if (currentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link"
                                           asp-action="Index"
                                           asp-route-page="1"
                                           asp-route-category="@Context.Request.Query["category"]"
                                           asp-route-search="@Context.Request.Query["search"]"
                                           asp-route-sort="@Context.Request.Query["sort"]">«</a>
                                    </li>
                                }

                                @for (int i = startPage; i <= endPage; i++)
                                {
                                    <li class="page-item @(currentPage == i ? "active" : "")">
                                        <a class="page-link"
                                           asp-action="Index"
                                           asp-route-page="@i"
                                           asp-route-category="@Context.Request.Query["category"]"
                                           asp-route-search="@Context.Request.Query["search"]"
                                           asp-route-sort="@Context.Request.Query["sort"]">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (currentPage < totalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link"
                                           asp-action="Index"
                                           asp-route-page="@totalPages"
                                           asp-route-category="@Context.Request.Query["category"]"
                                           asp-route-search="@Context.Request.Query["search"]"
                                           asp-route-sort="@Context.Request.Query["sort"]">»</a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }
                </div>
            }
        </div>
    </div>
</div>

<script>
        function themYeuThich(e) {
        e.preventDefault();

        const form = e.target;
        const button = form.querySelector('.nut-yeu-thich');

        button.classList.add('clicked');
        setTimeout(() => button.classList.remove('clicked'), 400);

        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData
        })
        .then(response => {
            if (response.ok) {
                const tb = document.getElementById("thongBaoYeuThich");
                tb.classList.add("hien");
                setTimeout(() => {
                    tb.classList.remove("hien");
                }, 3000);
            } else {
                alert("Đã xảy ra lỗi khi thêm vào yêu thích.");
            }
        })
        .catch(error => console.error("Lỗi:", error));
    }
</script>