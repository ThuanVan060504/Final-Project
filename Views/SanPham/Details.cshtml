@using Final_Project.Models.Shop
@model SanPham
@{
    ViewData["Title"] = "Chi tiết sản phẩm";
}

<div class="container mt-5">
    <div class="row align-items-center">
        <!-- Hình ảnh sản phẩm -->
        <div class="col-lg-6 text-center mb-4 mb-lg-0">
            <img src="@Model.ImageURL" class="img-fluid rounded shadow-sm"
                 style="max-height: 500px; width: 100%; object-fit: contain;" alt="@Model.TenSP" />
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="col-lg-6">
            <h2 class="fw-bold text-danger">@Model.TenSP</h2>
            <h4 class="text-primary mt-3">@Model.DonGia.ToString("N0") đ</h4>
            <p class="mt-3 text-muted">@Model.MoTa</p>
            <div class="mt-4">
                <h6 class="fw-semibold">📐 Kích thước:</h6>
                <ul class="list-unstyled text-secondary fs-6">
                    <li>Chiều rộng: <strong>@Model.ChieuRong</strong> cm</li>
                    <li>Chiều cao: <strong>@Model.ChieuCao</strong> cm</li>
                    <li>Chiều sâu: <strong>@Model.ChieuSau</strong> cm</li>
                </ul>
            </div>


            <!-- Nút thêm vào giỏ hàng -->
            <form asp-controller="GioHang" asp-action="ThemGioHang" method="post">
                <input type="hidden" name="maSP" value="@Model.MaSP" />
                <div class="mt-3">
                    <label for="soLuong" class="form-label">Số lượng:</label>
                    <div class="input-group" style="width: 150px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="thayDoiSoLuong(-1)"> − </button>
                        <input type="number" id="soLuong" name="soLuong" class="form-control text-center" value="1" min="1" />
                        <button class="btn btn-outline-secondary" type="button" onclick="thayDoiSoLuong(1)"> + </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-danger mt-4 px-4 py-2">
                    🛒 Thêm vào giỏ hàng
                </button>
            </form>
            <script>
                function thayDoiSoLuong(delta) {
                    const input = document.getElementById("soLuong");
                    let value = parseInt(input.value);
                    if (isNaN(value)) value = 1;
                    value += delta;
                    if (value < 1) value = 1;
                    input.value = value;
                }
            </script>

            <!-- Accordion phương thức thanh toán -->
            <div class="mt-5">
                <h5 class="text-dark mb-3 fw-bold">Phương thức thanh toán hỗ trợ:</h5>
                <div class="accordion" id="paymentAccordion">
                    <!-- Visa -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingVisa">
                            <button class="accordion-button collapsed text-danger fs-5" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVisa" aria-expanded="false" aria-controls="collapseVisa">
                                💳 Visa / MasterCard
                            </button>
                        </h2>
                        <div id="collapseVisa" class="accordion-collapse collapse" aria-labelledby="headingVisa" data-bs-parent="#paymentAccordion">
                            <div class="accordion-body border-top border-danger">
                                Nhập thông tin thẻ Visa/MasterCard tại trang thanh toán. Hệ thống sẽ xử lý an toàn qua cổng thanh toán quốc tế.
                            </div>
                        </div>
                    </div>

                    <!-- Momo/ZaloPay -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingMomo">
                            <button class="accordion-button collapsed text-success fs-5" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMomo" aria-expanded="false" aria-controls="collapseMomo">
                                📱 Momo / ZaloPay
                            </button>
                        </h2>
                        <div id="collapseMomo" class="accordion-collapse collapse" aria-labelledby="headingMomo" data-bs-parent="#paymentAccordion">
                            <div class="accordion-body border-top border-success">
                                Quét mã QR hoặc nhập số điện thoại: <strong>09xx xxx xxx</strong> trong app Momo/ZaloPay để hoàn tất thanh toán.
                            </div>
                        </div>
                    </div>

                    <!-- Chuyển khoản -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingBank">
                            <button class="accordion-button collapsed text-primary fs-5" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBank" aria-expanded="false" aria-controls="collapseBank">
                                🏦 Chuyển khoản
                            </button>
                        </h2>
                        <div id="collapseBank" class="accordion-collapse collapse" aria-labelledby="headingBank" data-bs-parent="#paymentAccordion">
                            <div class="accordion-body border-top border-primary">
                                Chuyển khoản đến STK: <strong>123456789</strong><br />
                                Ngân hàng: <strong>Vietcombank</strong><br />
                                Nội dung: <code>Thanh toán đơn hàng [mã]</code>
                            </div>
                        </div>
                    </div>

                    <!-- COD -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCOD">
                            <button class="accordion-button collapsed text-dark fs-5" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCOD" aria-expanded="false" aria-controls="collapseCOD">
                                📦 Thanh toán khi nhận
                            </button>
                        </h2>
                        <div id="collapseCOD" class="accordion-collapse collapse" aria-labelledby="headingCOD" data-bs-parent="#paymentAccordion">
                            <div class="accordion-body border-top border-secondary">
                                Thanh toán trực tiếp khi nhận hàng. Vui lòng chuẩn bị đủ tiền mặt và kiểm tra hàng hóa trước khi thanh toán.
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Giới thiệu chi tiết sản phẩm -->
    <div class="row mt-5">
        <div class="col-12">
            <h4 class="fw-bold text-dark mb-3 fs-3">📌 Giới thiệu chi tiết sản phẩm</h4>
            <p class="text-secondary fs-5" style="line-height: 1.9;">
                @Model.ChiTiet
            </p>
        </div>
    </div>
</div>

@if (ViewBag.SanPhamTuongTu != null && ((List<SanPham>)ViewBag.SanPhamTuongTu).Any())
{
    <div class="mt-5">
        <h4 class="fw-bold text-dark mb-4 fs-4">🧡 Sản phẩm tương tự</h4>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4">
            @foreach (var item in (List<SanPham>)ViewBag.SanPhamTuongTu)
            {
                <div class="col">
                    <a asp-controller="SanPham" asp-action="Details" asp-route-id="@item.MaSP" class="text-decoration-none text-dark">
                        <div class="card h-100 border-0 shadow-sm">
                            <img src="@item.ImageURL" class="card-img-top" alt="@item.TenSP" style="height: 170px; object-fit: contain;" />
                            <div class="card-body">
                                <h6 class="fw-semibold">@item.TenSP</h6>
                                <p class="text-danger fw-bold">@item.DonGia.ToString("N0") đ</p>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
}

<hr />
<style>
    .btn-check:checked + .btn-outline-warning {
        background-color: #ffc107;
        color: black;
        font-weight: bold;
        border-color: #ffc107;
    }

    .btn-outline-warning {
        padding: 5px 10px;
        font-size: 18px;
    }

    .form-check-inline {
        display: flex;
        gap: 8px;
    }
    /* Ẩn nút tăng/giảm mặc định trong các trình duyệt */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield; /* Firefox */
    }

</style>

<h4 class="text-dark mt-5">📝 Viết đánh giá</h4>

@if (!User.Identity.IsAuthenticated)
{
    <div class="alert alert-warning">
        Bạn cần <a asp-controller="Auth" asp-action="Login">đăng nhập</a> để viết đánh giá.
    </div>
}
else
{
    <form method="post" asp-action="GuiDanhGia">
        <input type="hidden" name="SanPhamId" value="@Model.MaSP" />

        @{
            var tenNguoiDung = User.Identity.Name ?? "Ẩn danh";
        }

        <input type="hidden" name="TenNguoiDung" value="@tenNguoiDung" />
        <div class="mb-3">
            <label class="form-label">Tên của bạn</label>
            <p class="text-muted">👤 <strong>@tenNguoiDung</strong></p>
        </div>

        <div class="mb-3">
            <label class="form-label">Chọn số sao</label>
            <div class="form-check form-check-inline">
                @for (int i = 5; i >= 1; i--)
                {
                    <input class="btn-check" type="radio" name="Diem" id="sao-@i" value="@i" @(i == 5 ? "checked" : "") />
                    <label class="btn btn-outline-warning" for="sao-@i">
                        @for (int j = 1; j <= i; j++)
                        {
                            <span>★</span>
                        }
                    </label>
                }
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Bình luận</label>
            <textarea name="BinhLuan" class="form-control" rows="3" required placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
    </form>
}

<!-- Hiển thị các đánh giá -->
<h4 class="mt-5 mb-3">📢 Đánh giá từ người dùng:</h4>

@if (ViewBag.DanhGiaList != null && ViewBag.DanhGiaList.Count > 0)
{
    @foreach (var dg in ViewBag.DanhGiaList)
    {
        <div class="border rounded p-3 mb-3 shadow-sm">
            <strong>@dg.TenNguoiDung</strong> - @dg.ThoiGian.ToString("dd/MM/yyyy HH:mm")<br />
            ⭐ @dg.Diem sao
            <p class="mt-2">@dg.BinhLuan</p>
        </div>
    }
}
else
{
    <p class="text-muted fst-italic">Chưa có đánh giá nào.</p>
}

